# Implementation Plan: PH-10 -- Box the Large Enum Variant

**Status:** PLAN_APPROVED
**Ticket:** PH-10 "Phase 10: Box the large enum variant"
**PRD:** `docs/prd/PH-10.prd.md`
**Research:** `docs/research/PH-10.md`
**Phase spec:** `docs/phase/phase-10.md`

---

## Components

### 1. Enum variant -- Change `Connect(AuthData)` to `Connect(Box<AuthData>)`

**File:** `src/parse.rs`, line 983

The `AppLogTraceKind` enum contains a `Connect(AuthData)` variant where `AuthData` is a newtype wrapping `[u8; 1024]`. Because Rust sizes enums to their largest variant, every value of `AppLogTraceKind` (and every enum in the chain above it: `AppLogKind`, `LogKind`, `LogLine`) carries ~1024 bytes of stack overhead, even for variants that contain only a `String` (24 bytes) or `Announcements` (much smaller).

**Current (line 983):**
```rust
pub enum AppLogTraceKind {
    Connect(AuthData),       // 1024 bytes inline
    SendRequest(String),
    Check(Announcements),
    GetResponse(String),
}
```

**After:**
```rust
pub enum AppLogTraceKind {
    Connect(Box<AuthData>),  // 8 bytes (pointer) inline; 1024 bytes on heap
    SendRequest(String),
    Check(Announcements),
    GetResponse(String),
}
```

This reduces `AppLogTraceKind` from ~1032 bytes to ~32 bytes on the stack, and the size reduction propagates through the entire hierarchy: `AppLogKind`, `LogKind`, and `LogLine` all shrink from ~1040 bytes to ~40 bytes.

### 2. Parser closure -- Wrap parsed `AuthData` in `Box::new()`

**File:** `src/parse.rs`, line 1181

The `Parsable` impl for `AppLogTraceKind` uses a `map` combinator with a closure that constructs `AppLogTraceKind::Connect(authdata)`. This closure must be updated to wrap the value in `Box::new()`.

**Current (line 1181):**
```rust
|authdata| AppLogTraceKind::Connect(authdata),
```

**After:**
```rust
|authdata| AppLogTraceKind::Connect(Box::new(authdata)),
```

The associated type at line 1153 (`fn(AuthData) -> AppLogTraceKind`) does NOT change. The closure still accepts `AuthData` as input (from `AuthData::parser()`) and returns `AppLogTraceKind`. Since `|authdata| AppLogTraceKind::Connect(Box::new(authdata))` is a non-capturing closure, it coerces to the function pointer type `fn(AuthData) -> AppLogTraceKind`. This is a well-understood Rust coercion rule: non-capturing closures coerce to `fn` pointers.

If the compiler rejects the coercion for any reason (unlikely), the fallback is to define a named function:
```rust
fn connect_boxed(authdata: AuthData) -> AppLogTraceKind {
    AppLogTraceKind::Connect(Box::new(authdata))
}
```
and pass `connect_boxed` as the map function argument.

### 3. Test assertion -- Update `test_log_kind` expected value

**File:** `src/parse.rs`, line 1652

The `test_log_kind` test constructs an expected `AppLogTraceKind::Connect(AuthData([...]))` value. With the variant changed to `Connect(Box<AuthData>)`, the expected value must wrap `AuthData` in `Box::new()`.

**Current (line 1652):**
```rust
...AppLogTraceKind::Connect(AuthData([0x30,0xc3,...]))...
```

**After:**
```rust
...AppLogTraceKind::Connect(Box::new(AuthData([0x30,0xc3,...])))...
```

Note: `test_authdata` (line 1546) tests `AuthData::parser()` directly and does not reference the `Connect` variant. It requires no changes.

### 4. Hint comments -- Remove both resolved markers

**File:** `src/parse.rs`, lines 722 and 979

Two `// подсказка:` comments identify this technical debt:
- Line 722: `// подсказка: довольно много места на стэке` ("hint: quite a lot of space on the stack") -- above `AuthData` struct
- Line 979: `// подсказка: а поля не слишком много места на стэке занимают?` ("hint: don't the fields take up too much stack space?") -- above `AppLogTraceKind` enum

Both comments are removed after the fix is applied, per the project convention: "Every `// подсказка:` marker is a mandatory fix location."

---

## API Contract

### Before and After -- Unchanged

The public type `AppLogTraceKind` changes its `Connect` variant from `Connect(AuthData)` to `Connect(Box<AuthData>)`. This is a breaking change for external pattern-matching code, which is acceptable per the PRD constraints ("This is acceptable for this internal refactoring project").

All other public API surfaces are unchanged:
- `read_log()` signature: unchanged
- `LogLine`, `LogKind`, `AppLogKind` enum structures: unchanged (they contain `AppLogTraceKind` transitively, but their variant shapes are identical)
- `AuthData` struct: unchanged (`pub struct AuthData([u8; AUTHDATA_SIZE])`)
- `Debug` output: unchanged (`Box<T>` delegates to `T::fmt()`, so printed output is identical)

### Internal consumers -- No changes needed

A grep for `Connect(` across `src/` confirms only three sites in `src/parse.rs`:
1. Line 983: Variant definition (changed)
2. Line 1181: Parser closure (changed)
3. Line 1652: Test assertion (changed)

No code in `src/lib.rs` or `src/main.rs` constructs or destructures the `Connect` variant. The `read_log()` filtering logic uses `matches!()` macros that check variant shapes without destructuring inner data.

---

## Data Flows

```
Log file / input stream
  |
  v
LogIterator::new(input) -> yields Result<LogLine, io::Error>
  |
  v
LogLine { kind: LogKind, request_id: u32 }
  |
  v  (when kind is App::Trace::Connect)
LogKind::App(AppLogKind::Trace(AppLogTraceKind::Connect(Box<AuthData>)))
  |                                                       ^^^^^^^^^^^^^
  |                                         8-byte pointer on stack;
  |                                         1024-byte payload on heap
  v
All other variants: ~24-32 bytes on stack (unchanged)
```

The data flow is functionally identical to the pre-refactoring version. The only difference is that `AuthData` for `Connect` log lines is heap-allocated instead of inline. The parsed bytes are identical; the `Box::new()` wrapping happens inside the parser closure immediately after `AuthData::parser()` produces the value.

---

## NFR (Non-Functional Requirements)

| Requirement | How Met |
|---|---|
| Zero external dependencies | No new crates. Uses only `Box` from the standard library. |
| No behavior changes | Same input produces same output. `Debug` output unchanged because `Box<T>` delegates to `T::fmt()`. `Clone` and `PartialEq` continue to work because `Box<T>` implements both when `T` does. |
| No test deletions | All existing tests are preserved. `test_log_kind` is adapted to use `Box::new()` in the expected value. `test_authdata` is unchanged. |
| Scope boundary | Only `src/parse.rs` is modified. Changes are limited to the `Connect` variant definition, its parser closure, and the `test_log_kind` assertion. `AuthData` struct itself is unchanged. |
| Hint comments resolved | Both `// подсказка:` comments (lines 722 and 979) are removed because the technical debt they identify is resolved. |
| Conventions compliance | Follows `docs/conventions.md` "Idiomatic Rust" table: "Instead of Large enum variant `AuthData([u8; 1024])` -> Use `Box<AuthData>` -- eliminate stack bloat". |
| Size reduction | `std::mem::size_of::<AppLogTraceKind>()` reduced from ~1032 bytes to ~32 bytes. `std::mem::size_of::<LogLine>()` reduced from ~1040 bytes to ~40 bytes. |

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Closure-to-function-pointer coercion: the closure `\|authdata\| AppLogTraceKind::Connect(Box::new(authdata))` must coerce to `fn(AuthData) -> AppLogTraceKind` for the associated type to remain unchanged | Low | Low | Non-capturing closures coerce to `fn` pointers in Rust. This is guaranteed by the language specification. If it fails (e.g., due to an edge case in the combinator type system), use a named function `connect_boxed` instead. |
| Heap allocation overhead: every `Connect` log entry now requires one heap allocation | Low | Negligible | The 1024-byte `AuthData` is already being parsed byte-by-byte from a hex string. A single heap allocation is negligible compared to the parsing cost. The benefit of reducing every `LogLine` from ~1040 to ~40 bytes vastly outweighs the cost. |
| Pattern-matching in `src/lib.rs`: if any `match` arms destructure `Connect(authdata)` | None | None | Verified: no code in `lib.rs` or `main.rs` destructures the `Connect` variant. Only `matches!()` macros are used, which check variant shape without binding inner data. |

---

## Deviations to Fix

**None.** The current codebase state matches the PRD's description exactly:

- `AuthData` struct is at line 725 with hint comment at line 722 -- confirmed.
- `AppLogTraceKind::Connect(AuthData)` is at line 983 with hint comment at line 979 -- confirmed.
- The `Parsable` impl for `AppLogTraceKind` uses `fn(AuthData) -> AppLogTraceKind` at line 1153 -- confirmed.
- The parser closure at line 1181 uses `|authdata| AppLogTraceKind::Connect(authdata)` -- confirmed.
- The test assertion at line 1652 uses `AppLogTraceKind::Connect(AuthData([...]))` -- confirmed.
- `test_authdata` (line 1546) does not reference `Connect` and needs no changes -- confirmed.
- No code outside `src/parse.rs` constructs or destructures the `Connect` variant -- confirmed.

No code deviates from requirements. No corrective tasks are needed.

---

## Implementation Tasks

### Task 10.1: Remove hint comment above `AuthData` struct

**File:** `src/parse.rs`, line 722

Remove the line:
```rust
// подсказка: довольно много места на стэке
```

This comment identifies the `AuthData` struct as oversized on the stack. The issue is resolved by boxing the variant that contains it.

### Task 10.2: Remove hint comment above `AppLogTraceKind` and change `Connect` variant to `Box<AuthData>`

**File:** `src/parse.rs`, lines 979 and 983

Remove the line:
```rust
// подсказка: а поля не слишком много места на стэке занимают?
```

And change line 983 from:
```rust
    Connect(AuthData),
```
to:
```rust
    Connect(Box<AuthData>),
```

### Task 10.3: Update the parser closure to wrap `AuthData` in `Box::new()`

**File:** `src/parse.rs`, line 1181

Change from:
```rust
                    |authdata| AppLogTraceKind::Connect(authdata),
```
to:
```rust
                    |authdata| AppLogTraceKind::Connect(Box::new(authdata)),
```

The associated type `fn(AuthData) -> AppLogTraceKind` at line 1153 remains unchanged.

### Task 10.4: Update `test_log_kind` expected value

**File:** `src/parse.rs`, line 1652

Change the expected value from:
```rust
...AppLogTraceKind::Connect(AuthData([0x30,0xc3,...]))...
```
to:
```rust
...AppLogTraceKind::Connect(Box::new(AuthData([0x30,0xc3,...])))...
```

### Task 10.5: Verify

Run the acceptance criteria:

```bash
cargo test                # All tests pass (no test cases deleted)
cargo run -- example.log  # Output identical to pre-refactoring
```

Additionally verify:

| Check | Expected |
|---|---|
| `Connect(Box<AuthData>)` in enum definition | Present |
| `Box::new(authdata)` in parser closure | Present |
| `Box::new(AuthData([...]))` in test assertion | Present |
| `// подсказка: довольно много места на стэке` | Gone |
| `// подсказка: а поля не слишком много места на стэке занимают?` | Gone |
| `fn(AuthData) -> AppLogTraceKind` associated type | Unchanged |
| `AuthData` struct definition | Unchanged |
| `test_authdata` test | Unchanged |
| Changes in `src/lib.rs` | None |
| Changes in `src/main.rs` | None |
| External dependencies | Zero (unchanged) |
| Number of tests | Same as before (none deleted) |

---

## Open Questions

None. The phase specification is complete, the scope is well-defined, and the implementation path is clear. The single change -- wrapping `AuthData` in `Box<>` at the `Connect` variant -- has well-understood implications for the parser type signature and test assertions. No architectural decision record is needed because there is only one viable approach: `Box<AuthData>` at the variant level, which is the standard Rust pattern for reducing enum size when one variant is significantly larger than the others.
