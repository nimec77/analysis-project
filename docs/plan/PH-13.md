# Implementation Plan: PH-13 -- Bug fix + dead code cleanup

**Ticket:** PH-13
**Status:** PLAN_APPROVED
**PRD:** `docs/prd/PH-13.prd.md`
**Research:** `docs/research/PH-13.md`
**Phase:** 13 of 22

---

## Components

This phase modifies a single file: `src/parse.rs`. There are two distinct components of work:

### Component 1: WithdrawCash Bug Fix + Regression Test

**Location:** `src/parse.rs`, line 1320 (inside `Parsable` impl for `AppLogJournalKind`)

The `WithdrawCash` parser arm at line 1318-1321 correctly parses the `"WithdrawCash"` tag and a `UserCash` payload via `preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser())`, but the mapping closure produces `AppLogJournalKind::DepositCash(user_cash)` instead of `AppLogJournalKind::WithdrawCash(user_cash)`. This is a copy-paste error from the `DepositCash` arm directly above (lines 1314-1316).

A new test `test_withdraw_cash` is added to the `mod test` block to prevent regression.

### Component 2: Dead Code Removal

Five items to delete from `src/parse.rs`, all confirmed unused via project-wide search and compiler warnings:

| Item | Location | Lines to delete |
|---|---|---|
| `AsIs` struct + `Parser` impl | Lines 136-144 | 9 lines (doc comment, `#[derive]`, struct, impl block) |
| `all3()` constructor | Lines 329-335 | 7 lines (doc comments, function) |
| `all4()` constructor | Lines 354-365 | 12 lines (doc comments, function) |
| `Either<L, R>` enum | Lines 730-734 | 5 lines (doc comment, enum) |
| `Status` enum + `Parsable` impl | Lines 736-758 | 23 lines (doc comment, enum, impl block) |

**Retained items:** The `impl Parser for All<(A0, A1, A2)>` (lines 314-328) and `impl Parser for All<(A0, A1, A2, A3)>` (lines 336-353) are NOT deleted -- only the convenience constructor functions are removed.

---

## API Contract

No public API changes. The bug fix corrects internal behavior only:

- **Before:** `LogKind::parser().parse("...WithdrawCash...")` produces `AppLogJournalKind::DepositCash(...)` (incorrect)
- **After:** `LogKind::parser().parse("...WithdrawCash...")` produces `AppLogJournalKind::WithdrawCash(...)` (correct)

All removed items (`AsIs`, `Either`, `Status`, `all3`, `all4`) are private (no `pub` visibility). No external consumers are affected.

---

## Data Flows

No changes to data flows. The parsing pipeline remains identical:

```
Input string --> LogLine::parser() --> LogKind --> AppLogKind::Journal --> AppLogJournalKind
```

The only change is that the `WithdrawCash` arm now correctly maps to `AppLogJournalKind::WithdrawCash` instead of `AppLogJournalKind::DepositCash`.

---

## NFR

| Requirement | How addressed |
|---|---|
| Zero external dependencies | No new crates. Only `src/parse.rs` modified. |
| No behavior changes (except bug fix) | Dead code removal has zero runtime effect. Bug fix corrects incorrect behavior. |
| Never delete tests | No tests deleted. One test added (`test_withdraw_cash`). |
| `cargo test` passes | Verified after each change. |
| `cargo run -- example.log` identical output | No `WithdrawCash` entries in `example.log`; dead code removal has no effect. |

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Line numbers shifted from earlier phases | Certain | None | Items located by name/pattern, not line number. PRD notes this. Verified in current codebase: line numbers match. |
| Removing dead code causes compilation failure from missed reference | Very Low | Low | All items confirmed unused via grep and compiler warnings. `cargo build` after removal surfaces any issues immediately. |
| `WithdrawCash` fix changes output for log files with `WithdrawCash` entries | Certain | Low (intended) | This is the intended correction. `example.log` has no `WithdrawCash` entries, so CLI output is unchanged. New regression test validates correctness. |
| PRD test scenario uses `"cash"` but actual parser uses `"count"` | None (identified) | None | Research document identified this discrepancy. The test uses the correct field name `"count"` per the actual `UserCash` parser (line 844). |

---

## Deviations to Fix

**No deviations found.** The current codebase matches the PRD's description exactly. The research document (section 13) confirms zero deviations.

**Minor PRD inaccuracy (non-blocking):** PRD scenario 2 uses `"cash":500` as a field in the test input. The actual `UserCash` parser uses `"count"` as the key name (line 844). The implementation test will use the correct field name `"count"`. This is not a deviation -- the PRD scenario was illustrative and the parser's actual field name is authoritative.

---

## Implementation Steps

### Step 1: Fix the WithdrawCash bug (task 13.1)

**File:** `src/parse.rs`, line 1320

**Change:** Replace `AppLogJournalKind::DepositCash(user_cash)` with `AppLogJournalKind::WithdrawCash(user_cash)` in the mapping closure of the `WithdrawCash` parser arm.

**Before:**
```rust
map(
    preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::DepositCash(user_cash),
),
```

**After:**
```rust
map(
    preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::WithdrawCash(user_cash),
),
```

**Verification:** `cargo build` compiles without errors. Existing tests pass.

### Step 2: Add WithdrawCash regression test (task 13.2)

**File:** `src/parse.rs`, inside `mod test`, after the `test_log_kind` function (after line 1682)

**Add new test function:**
```rust
#[test]
fn test_withdraw_cash() {
    assert_eq!(
        LogKind::parser()
            .parse(r#"App::Journal WithdrawCash UserCash{"user_id":"Alice","count":500,}"#),
        Ok((
            "",
            LogKind::App(AppLogKind::Journal(AppLogJournalKind::WithdrawCash(
                UserCash {
                    user_id: "Alice".into(),
                    count: nz(500)
                }
            )))
        ))
    );
}
```

**Notes:**
- Uses `"count"` (not `"cash"`) per the actual `UserCash` parser at line 844.
- Uses the `nz()` helper (line 1402) consistent with other tests.
- Asserts `AppLogJournalKind::WithdrawCash(...)` -- would fail before the bug fix in Step 1.

**Verification:** `cargo test test_withdraw_cash` passes. All existing tests pass.

### Step 3: Remove dead code -- bottom-up deletion order (tasks 13.3-13.7)

Dead code is deleted in reverse line-number order to avoid line-shift issues during editing:

#### 3a: Delete `Status` enum + `Parsable` impl (lines 736-758, task 13.5)

Delete the doc comment, enum definition, and entire `impl Parsable for Status` block (23 lines).

**Verification:** `cargo build` succeeds. No references to `Status` remain.

#### 3b: Delete `Either<Left, Right>` enum (lines 730-734, task 13.4)

Delete the doc comment and enum definition (5 lines).

**Verification:** `cargo build` succeeds. No references to `Either` remain.

#### 3c: Delete `all4()` constructor (lines 354-365, task 13.7)

Delete the doc comments and function definition (12 lines). The `impl Parser for All<(A0, A1, A2, A3)>` block (lines 336-353) is retained.

**Verification:** `cargo build` succeeds. No references to `all4` remain.

#### 3d: Delete `all3()` constructor (lines 329-335, task 13.6)

Delete the doc comments and function definition (7 lines). The `impl Parser for All<(A0, A1, A2)>` block (lines 314-328) is retained.

**Verification:** `cargo build` succeeds. No references to `all3` remain.

#### 3e: Delete `AsIs` struct + `Parser` impl (lines 136-144, task 13.3)

Delete the doc comment, `#[derive]` attribute, struct definition, and `impl Parser for AsIs` block (9 lines).

**Verification:** `cargo build` succeeds. No references to `AsIs` remain.

### Step 4: Final verification

```bash
cargo test                    # All tests pass (existing + new test_withdraw_cash)
cargo run -- example.log      # Output identical to pre-phase
```

Additional checks:
- Zero occurrences of `AsIs`, `Either`, `enum Status`, `fn all3`, `fn all4` in `src/parse.rs`
- Dead-code warnings reduced from 7 to 2 (only `quote` and `I32` remain -- out of scope)
- No external dependencies added
- Only `src/parse.rs` modified

---

## Commit Strategy

Per project conventions ("one issue category = one commit"), the changes split into two commits:

1. **Bug fix commit:** Fix `WithdrawCash` mapping + add `test_withdraw_cash` regression test (tasks 13.1, 13.2)
2. **Dead code cleanup commit:** Remove `AsIs`, `Either`, `Status`, `all3`, `all4` (tasks 13.3-13.7)

---

## Open Questions

None. The phase specification is complete, all items have been located and verified in the current codebase, and the research document confirms zero deviations.
