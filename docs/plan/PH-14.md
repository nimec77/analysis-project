# Plan: PH-14 — Naming improvements

**Status:** PLAN_APPROVED
**Ticket:** PH-14
**PRD:** `docs/prd/PH-14.prd.md`
**Research:** `docs/research/PH-14.md`
**Phase spec:** `docs/phase/phase-14.md`

---

## Components

This phase modifies a single component:

### `src/parse.rs` — Parser module

The parser module contains all five items to be renamed and all their references. No other files are affected.

| Item | Current Name | New Name | Occurrences |
|---|---|---|---|
| Struct | `All<T>` | `Tuple<T>` | 14 |
| Constructor function | `all2()` | `tuple2()` | 9 (1 def + 8 call sites) |
| Module | `stdp` | `primitives` | 39 (1 decl + 38 qualified refs) |
| Function | `do_unquote()` | `unquote_escaped()` | 3 (1 def + 1 doc link + 1 call site) |
| Function | `do_unquote_non_escaped()` | `unquote_simple()` | 5 (1 def + 1 call site + 3 test refs) |
| Test function | `test_do_unquote_non_escaped()` | `test_unquote_simple()` | 1 |

Additionally, 3 doc comment lines require identifier name updates within their text.

---

## API Contract

**No API changes.** All renamed items are internal to `src/parse.rs`. Although `All` (now `Tuple`) and some combinator structs are declared `pub`, they are only referenced within `parse.rs`. The public API of the library crate (`read_log`, `LogLine`, `LogKind`, domain types) is unchanged.

The `use parse::*;` import in `lib.rs` will transparently pick up the renamed types without any code changes in `lib.rs`.

---

## Data Flows

**No data flow changes.** This is a pure renaming refactor. The parser combinators continue to compose identically, producing the same parse trees from the same input. The only difference is the names of types and functions in source code.

---

## Implementation Tasks

All changes target `src/parse.rs` exclusively.

### Task 1: Rename `do_unquote()` to `unquote_escaped()` (3 occurrences)

| Location | Line | Change |
|---|---|---|
| Function definition | 93 | `fn do_unquote(` to `fn unquote_escaped(` |
| Doc comment intra-doc link | 114 | `[do_unquote]` to `[unquote_escaped]` |
| Call site in `Unquote::parse()` | 129 | `do_unquote(input)` to `unquote_escaped(input)` |

### Task 2: Rename `do_unquote_non_escaped()` to `unquote_simple()` (5 occurrences + test function name)

| Location | Line | Change |
|---|---|---|
| Function definition | 115 | `fn do_unquote_non_escaped(` to `fn unquote_simple(` |
| Call site in `QuotedTag::parse()` | 158 | `do_unquote_non_escaped(input)` to `unquote_simple(input)` |
| Test assertion 1 | 1389 | `do_unquote_non_escaped(` to `unquote_simple(` |
| Test assertion 2 | 1390 | `do_unquote_non_escaped(` to `unquote_simple(` |
| Test assertion 3 | 1391 | `do_unquote_non_escaped(` to `unquote_simple(` |
| Test function name | 1388 | `fn test_do_unquote_non_escaped()` to `fn test_unquote_simple()` |

### Task 3: Rename `All` struct to `Tuple` (14 occurrences)

| Location | Line | Change |
|---|---|---|
| Doc comment | 280 | `` `all` `` to `` `tuple` `` |
| Struct definition | 282 | `pub struct All<T>` to `pub struct Tuple<T>` |
| Parser impl (2-tuple) | 285 | `impl<A0, A1> Parser for All<(A0, A1)>` to `...Tuple<(A0, A1)>` |
| Doc comment link | 299 | `[All]` to `[Tuple]` |
| Return type of `all2`/`tuple2` | 301 | `-> All<(A0, A1)>` to `-> Tuple<(A0, A1)>` |
| Constructor expression | 302 | `All { parser: (a0, a1) }` to `Tuple { parser: (a0, a1) }` |
| Parser impl (3-tuple) | 304 | `impl<...> Parser for All<(A0, A1, A2)>` to `...Tuple<(A0, A1, A2)>` |
| Parser impl (4-tuple) | 320 | `impl<...> Parser for All<(A0, A1, A2, A3)>` to `...Tuple<(A0, A1, A2, A3)>` |
| Type annotation — `KeyValue` | 344 | `All<(StripWhitespace<QuotedTag>, ...)>` to `Tuple<(...)>` |
| Type annotation — `AssetDsc` | 712 | `All<(...)>` to `Tuple<(...)>` |
| Type annotation — `Backet` | 742 | `All<(...)>` to `Tuple<(...)>` |
| Type annotation — `UserCash` | 771 | `All<(...)>` to `Tuple<(...)>` |
| Type annotation — `UserBacket` | 803 | `All<(...)>` to `Tuple<(...)>` |
| Type annotation — `UserBackets` | 835 | `All<(...)>` to `Tuple<(...)>` |
| Type annotation — `LogLine` | 1322 | `All<(...)>` to `Tuple<(...)>` |

### Task 4: Rename `all2()` to `tuple2()` (9 occurrences)

| Location | Line | Change |
|---|---|---|
| Function definition | 301 | `fn all2<` to `fn tuple2<` |
| Call site — `key_value()` | 362 | `all2(` to `tuple2(` |
| Call site — `AssetDsc::parser()` | 722 | `all2(` to `tuple2(` |
| Call site — `Backet::parser()` | 751 | `all2(` to `tuple2(` |
| Call site — `UserCash::parser()` | 780 | `all2(` to `tuple2(` |
| Call site — `UserBacket::parser()` | 812 | `all2(` to `tuple2(` |
| Call site — `UserBackets::parser()` | 847 | `all2(` to `tuple2(` |
| Call site — `LogLine::parser()` | 1330 | `all2(` to `tuple2(` |
| Call site — `test_asset_dsc` test | 1491 | `all2(` to `tuple2(` |

### Task 5: Rename `stdp` module to `primitives` (39 occurrences)

| Location | Change |
|---|---|
| Module declaration (line 14) | `mod stdp {` to `mod primitives {` |
| 38 qualified references | `stdp::U32` to `primitives::U32`, `stdp::I32` to `primitives::I32`, `stdp::Byte` to `primitives::Byte` |

Breakdown by qualified name:
- `stdp::U32`: 32 occurrences (type annotations + constructor usages + test code)
- `stdp::I32`: 6 occurrences (all in test code)
- `stdp::Byte`: 2 occurrences (in `AuthData` parser)

### Task 6: Verification

Run `cargo test` and `cargo run -- example.log` to verify:
- All 26 tests pass
- CLI output is identical to pre-phase
- Zero occurrences of old names remain in `src/parse.rs`
- Zero new compiler warnings introduced

---

## NFR (Non-Functional Requirements)

| Requirement | How Met |
|---|---|
| Zero external dependencies | No crate additions. Pure source-level rename. |
| No behavior changes | Same input produces same output. Pure rename. |
| No test deletions | All tests preserved; only function/identifier names updated. |
| Single file scope | Only `src/parse.rs` is modified. |
| One commit | All renames in a single commit per project conventions. |
| Russian comments preserved | Existing Russian text left as-is; only identifier names within comments updated. |

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Missed reference causes compilation error | Low | Low | `cargo build` immediately surfaces unresolved identifiers. Occurrence counts are verified by research. |
| `ReadMode::All` in `lib.rs`/`main.rs` accidentally renamed | None | N/A | `ReadMode::All` is an enum variant, not the parser `All<T>` struct. Confirmed by grep: different `All`. Renames scoped to `src/parse.rs` only. |
| `Tuple` name collision with stdlib | None | N/A | `Tuple` is not a Rust keyword. No `std::tuple` type. Local scope -- no conflict. |
| Large `stdp` replacement count (39) | Low | Low | Mechanical `stdp::` to `primitives::` prefix replacement. Compiler catches any miss. |
| Merge conflict with concurrent branches | Low | Low | Single-file modification, standalone phase. |
| Doc comment intra-doc links break | Very Low | Very Low | All 3 intra-doc link updates are enumerated. `cargo doc` would catch broken links. |

---

## Deviations to Fix

**None.** The research document (section 15) confirms no deviations between the current codebase and requirements. The codebase matches the PRD exactly. All occurrence counts are verified.

**Minor PRD count note (non-blocking):** The PRD gap analysis states "5 occurrences" for `do_unquote`, but word-boundary grep finds exactly 3 occurrences distinct from `do_unquote_non_escaped`. This does not affect the plan -- all 3 occurrences are enumerated in Task 1.

---

## Open Questions

None. The scope is fully defined, all items located and counted, no name collisions exist, and no architectural decisions are required. Each rename is a mechanical find-and-replace within a single file.

---

## Commit Strategy

Per project conventions ("one issue category = one commit"), all five renames plus doc comment updates go into a single commit. Suggested commit message:

```
refactor: rename parser identifiers for naming consistency (PH-14)

Rename All -> Tuple, all2 -> tuple2, stdp -> primitives,
do_unquote -> unquote_escaped, do_unquote_non_escaped -> unquote_simple.
```
