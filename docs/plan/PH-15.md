# Plan: PH-15 — Modularity (split `parse.rs`)

**Status:** PLAN_APPROVED
**Ticket:** PH-15
**PRD:** `docs/prd/PH-15.prd.md`
**Research:** `docs/research/PH-15.md`
**Phase spec:** `docs/phase/phase-15.md`

---

## Components

This phase converts the monolithic `src/parse.rs` (1762 lines) into a module directory with three sub-module files and a thin module root. No other source files are modified.

### 1. `src/parse.rs` — Module root (new role)

Currently a 1762-line monolithic file. Becomes a ~10-line module root that declares sub-modules and re-exports all public items.

### 2. `src/parse/combinators.rs` — Parser combinator framework (new file)

Contains the `Parser` and `Parsable` trait definitions, the `primitives` sub-module (`U32`, `I32`, `Byte`), all combinator structs (`Tag`, `Unquote`, `QuotedTag`, `StripWhitespace`, `Delimited`, `Map`, `Preceded`, `Tuple`, `KeyValue`, `Permutation`, `List`, `Alt`, `Take`), their `Parser` trait impls, all constructor functions, helper functions (`quote`, `unquote_escaped`, `unquote_simple`), and combinator-related tests.

### 3. `src/parse/domain.rs` — Domain types (new file)

Contains `AUTHDATA_SIZE` constant, `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements` (struct definitions + `Parsable` impls), the `just_parse` generic function, and domain-related tests.

### 4. `src/parse/log.rs` — Log hierarchy (new file)

Contains `LogLine`, `LogKind`, `SystemLogKind`, `SystemLogTraceKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogTraceKind`, `AppLogJournalKind` (enum definitions + `Parsable` impls), and log-related tests.

---

## API Contract

**No API changes.** The public API of the library crate remains identical:

- `read_log(impl Read, ReadMode, Vec<NonZeroU32>) -> Result<Vec<LogLine>, io::Error>`
- All types: `LogLine`, `LogKind`, `SystemLogKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogJournalKind`, `Parsable`, `Parser`, `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements`, `just_parse`

The `pub use combinators::*; pub use domain::*; pub use log::*;` re-exports in the module root ensure that `use parse::*;` in `lib.rs` continues to resolve all public types without any modification to `lib.rs` or `main.rs`.

**`src/lib.rs` changes:** Zero. The `pub mod parse; use parse::*;` declaration and all pattern matches in `read_log()` compile without modification.

**`src/main.rs` changes:** Zero. The `analysis::parse::just_parse::<analysis::parse::Announcements>()` path continues to work via re-exports.

---

## Data Flows

**No data flow changes.** This is a pure structural refactor. The parser combinators continue to compose identically, producing the same parse trees from the same input. The data flow remains:

```
log file / byte stream
        |
    LogIterator  (reads lines, skips blanks)
        |
    Parser       (parses each line into LogLine)
        |
    read_log()   (filters by mode + request_ids)
        |
    Vec<LogLine>
```

---

## Implementation Tasks

### Task 1: Create `src/parse/` directory

Create the `src/parse/` directory. This directory will contain the three sub-module files.

**Verification:** Directory exists.

### Task 2: Create `src/parse/combinators.rs`

Move current `src/parse.rs` lines 1-686 into `src/parse/combinators.rs`. This includes:

**Traits (lines 1-12):**
- `pub trait Parser` (lines 1-6)
- `pub trait Parsable` (lines 7-12)

**Primitives sub-module (lines 14-74):**
- Change `mod primitives` to `pub(crate) mod primitives` so that `domain.rs` and `log.rs` can access `primitives::U32`, `primitives::Byte` via the path `primitives::U32`
- Contents: `U32`, `I32`, `Byte` with their `Parser` impls

**Helper functions (lines 76-122):**
- `fn quote(...)` -- remains private (only used in combinator tests)
- `fn unquote_escaped(...)` -- remains private (only called by `Unquote::parse`)
- `fn unquote_simple(...)` -- remains private (only called by `QuotedTag::parse`)

**Combinator structs, impls, constructors (lines 124-686):**

All constructor functions change from `fn` to `pub(crate) fn`:

| Constructor | Line | Called from `domain.rs` | Called from `log.rs` |
|---|---|---|---|
| `unquote` | 133 | Yes | Yes |
| `tag` | 149 | Yes | Yes |
| `quoted_tag` | 166 | No | No |
| `strip_whitespace` | 183 | Yes | Yes |
| `delimited` | 215 | Yes | Yes |
| `map` | 247 | Yes | Yes |
| `preceded` | 269 | No | Yes |
| `tuple2` | 301 | Yes | No |
| `key_value` | 359 | Yes | Yes |
| `permutation2` | 403 | Yes | Yes |
| `permutation3` | 463 | No | Yes |
| `list` | 504 | Yes | No |
| `alt2` | 529 | No | Yes |
| `alt3` | 552 | No | Yes |
| `alt4` | 584 | No | Yes |
| `alt8` | 639 | No | Yes |
| `take` | 684 | Yes | No |

All 17 constructor functions become `pub(crate)` uniformly for consistency.

**Tests (from lines 1347-1762, combinator subset):**

Add a `#[cfg(test)] mod tests { ... }` block at the bottom of `combinators.rs` with these 11 tests:
- `test_u32` -- uses `primitives::U32`
- `test_i32` -- uses `primitives::I32`
- `test_quote` -- uses `quote()`
- `test_unquote_simple` -- uses `unquote_simple()`
- `test_unquote` -- uses `Unquote`
- `test_tag` -- uses `tag()`
- `test_quoted_tag` -- uses `quoted_tag()`
- `test_strip_whitespace` -- uses `strip_whitespace()`, `tag()`, `primitives::U32`
- `test_delimited` -- uses `delimited()`, `tag()`, `primitives::U32`
- `test_key_value` -- uses `key_value()`, `primitives::U32`
- `test_list` -- uses `list()`, `primitives::U32`

Tests use `use super::*;` to access all items in `combinators.rs` (including private items like `quote`, `unquote_simple`).

The helper function `fn nz(n: u32) -> NonZeroU32` is duplicated in this test block (trivial one-liner, keeps tests self-contained).

**Verification:** `cargo build` compiles `combinators.rs` in isolation.

### Task 3: Create `src/parse/domain.rs`

Move current `src/parse.rs` lines 688-877 into `src/parse/domain.rs`. This includes:

**Imports at the top:**
```rust
use super::combinators::*;
use super::combinators::primitives;
```

**Items moved:**
- `const AUTHDATA_SIZE: usize = 1024;` (line 688) -- stays private
- `AuthData` struct + `Parsable` impl (lines 690-702)
- `AssetDsc` struct + `Parsable` impl (lines 704-733)
- `Backet` struct + `Parsable` impl (lines 735-762)
- `UserCash` struct + `Parsable` impl (lines 764-794)
- `UserBacket` struct + `Parsable` impl (lines 796-826)
- `UserBackets` struct + `Parsable` impl (lines 828-861)
- `Announcements` struct + `Parsable` impl (lines 863-873)
- `pub fn just_parse<T: Parsable>(...)` (lines 875-877)

All struct definitions and their `Parsable` impls move together. The `Parsable` impls reference combinator types (`Map`, `Delimited`, `Tuple`, `Permutation`, `KeyValue`, `List`, `Unquote`, `Tag`, `StripWhitespace`, `Take`) and primitives (`primitives::U32`, `primitives::Byte`) which are available via the `use super::combinators::*;` and `use super::combinators::primitives;` imports.

**Tests (from lines 1347-1762, domain subset):**

Add a `#[cfg(test)] mod tests { ... }` block at the bottom of `domain.rs` with these 10 tests:
- `test_authdata` -- uses `AuthData::parser()`
- `test_asset_dsc` -- uses `AssetDsc::parser()`, `tuple2()`, `strip_whitespace()`, `tag()`
- `test_backet` -- uses `Backet::parser()`
- `test_just_parse_asset_dsc` -- uses `just_parse::<AssetDsc>()`
- `test_just_parse_backet` -- uses `just_parse::<Backet>()`
- `test_just_parse_user_cash` -- uses `just_parse::<UserCash>()`
- `test_just_parse_user_backet` -- uses `just_parse::<UserBacket>()`
- `test_just_parse_user_backets` -- uses `just_parse::<UserBackets>()`
- `test_just_parse_announcements` -- uses `just_parse::<Announcements>()`
- `test_just_parse_error_cases` -- uses `just_parse::<AssetDsc>()`, `just_parse::<Backet>()`, `just_parse::<Announcements>()`

Tests use `use super::*;` which gives access to all domain types and (via the module-level imports inherited through `super::*`) the combinator constructors `tuple2`, `strip_whitespace`, `tag` that are `pub(crate)`.

The helper function `fn nz(n: u32) -> NonZeroU32` is duplicated in this test block.

**Verification:** `cargo build` compiles `domain.rs` with its imports from `combinators`.

### Task 4: Create `src/parse/log.rs`

Move current `src/parse.rs` lines 879-1345 into `src/parse/log.rs`. This includes:

**Imports at the top:**
```rust
use super::combinators::*;
use super::combinators::primitives;
use super::domain::*;
```

**Items moved (9 enum/struct definitions + their `Parsable` impls):**
- `LogKind` enum + `Parsable` impl (lines 881-885 + impl)
- `SystemLogKind` enum + `Parsable` impl (lines 887-891 + impl)
- `SystemLogTraceKind` enum + `Parsable` impl (lines 893-897 + impl)
- `SystemLogErrorKind` enum + `Parsable` impl (lines 899-903 + impl)
- `AppLogKind` enum + `Parsable` impl (lines 905-910 + impl)
- `AppLogErrorKind` enum + `Parsable` impl (lines 912-916 + impl)
- `AppLogTraceKind` enum + `Parsable` impl (lines 918-924 + impl)
- `AppLogJournalKind` enum + `Parsable` impl (lines 926-1320 + impl)
- `LogLine` struct + `Parsable` impl (lines 1324-1345)

The `Parsable` impls reference:
- Combinator types: `Map`, `Preceded`, `StripWhitespace`, `Tag`, `Alt`, `Unquote`, `Delimited`, `Permutation`, `KeyValue`, `List`
- Primitives: `primitives::U32`
- Domain types: `AuthData`, `UserCash`, `UserBacket`, `Announcements`, `Backet`

All available via the three `use` imports at the top.

**Tests (from lines 1347-1762, log subset):**

Add a `#[cfg(test)] mod tests { ... }` block at the bottom of `log.rs` with these 2 tests:
- `test_log_kind` -- uses `LogKind::parser()`, `preceded()`, `strip_whitespace()`, `tag()`, `unquote()`, `AuthData`, `nz()`
- `test_withdraw_cash` -- uses `LogKind::parser()`, `nz()`

Tests use `use super::*;` which gives access to log types and (via the module-level imports inherited through `super::*`) both combinator and domain items.

The helper function `fn nz(n: u32) -> NonZeroU32` is duplicated in this test block.

**Verification:** `cargo build` compiles `log.rs` with its imports from `combinators` and `domain`.

### Task 5: Rewrite `src/parse.rs` as module root

Replace the entire 1762-line content of `src/parse.rs` with:

```rust
mod combinators;
mod domain;
mod log;

pub use combinators::*;
pub use domain::*;
pub use log::*;
```

This ensures:
- Sub-modules are declared and compiled
- All `pub` and `pub(crate)` items from each sub-module are re-exported as `pub` from the `parse` module
- `use parse::*;` in `lib.rs` continues to resolve all public types
- `analysis::parse::just_parse` and `analysis::parse::Announcements` in `main.rs` continue to resolve

**No `mod.rs` files.** Edition 2024 module paths mean `mod combinators;` resolves to `src/parse/combinators.rs` automatically.

### Task 6: Verification

Run the full verification suite:

1. **`cargo build`** -- must compile with zero errors
2. **`cargo test`** -- all 26 tests pass (23 in `parse` sub-modules + 3 in `lib`)
3. **`cargo run -- example.log`** -- output identical to pre-phase
4. **Zero new compiler warnings** -- the two pre-existing warnings (`quote` unused, `I32` unconstructed) may persist but no new warnings appear
5. **Zero `mod.rs` files** -- verify no `src/parse/mod.rs` exists
6. **`src/lib.rs` unchanged** -- diff shows no modifications
7. **`src/main.rs` unchanged** -- diff shows no modifications

---

## NFR (Non-Functional Requirements)

| Requirement | How Met |
|---|---|
| Zero external dependencies | No crate additions. Pure structural refactor. |
| No behavior changes | Same input produces same output. Code is moved, not modified. |
| No test deletions | All 26 tests preserved and redistributed across 3 sub-module test blocks. |
| Edition 2024 module paths | `src/parse/combinators.rs`, `src/parse/domain.rs`, `src/parse/log.rs` -- no `mod.rs`. |
| `src/lib.rs` unchanged | `pub mod parse; use parse::*;` continues to work via `pub use` re-exports. |
| `src/main.rs` unchanged | `analysis::parse::just_parse` and `analysis::parse::Announcements` resolve via re-exports. |
| One commit | Single commit per project conventions ("one issue category = one commit"). |
| Russian comments preserved | Existing Russian comments move with their code. No translation performed. |

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Missing `pub use` re-export causes compilation failure in `lib.rs` | Low | Low | Using `pub use combinators::*; pub use domain::*; pub use log::*;` re-exports all public items. `cargo build` immediately catches missing re-exports. Items needed by `lib.rs`: `LogLine`, `Parsable`, `Parser`, `LogKind`, `SystemLogKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogJournalKind`. |
| Constructor visibility prevents cross-module access | Low | Low | All 17 constructor functions become `pub(crate)`. `cargo build` catches any remaining visibility errors immediately. |
| `primitives` module visibility prevents access from `domain.rs`/`log.rs` | Low | Low | `primitives` becomes `pub(crate) mod primitives` in `combinators.rs`. Domain and log modules import it via `use super::combinators::primitives;`. |
| Test `use super::*;` breaks after move | Low | Low | Each test module uses `use super::*;` to import from its parent module. Since each module also imports its dependencies at the module level (e.g., `use super::combinators::*;`), `use super::*;` transitively provides access to those dependencies. |
| `log` sub-module name conflicts with external `log` crate | None | N/A | The project has zero dependencies; there is no `log` crate in scope. The name is safe. If a future phase adds the `log` crate, the module can be renamed then. |
| Circular dependency between sub-modules | None | N/A | The dependency graph is strictly layered: `combinators` <- `domain` <- `log`. No cycles exist. `combinators.rs` has no dependency on `domain.rs` or `log.rs`. |
| Edition 2024 `src/parse.rs` + `src/parse/` coexistence issue | None | N/A | Edition 2024 natively supports having both `src/parse.rs` (module root) and `src/parse/` (sub-module directory). This is the standard pattern. |
| Existing warnings increase | Very Low | Low | The two pre-existing warnings (`quote` unused, `I32` unconstructed) stay in `combinators.rs` with their test code. No new warnings should appear from visibility or import changes. |

---

## Deviations to Fix

**None.** The research document (section 8) confirms no deviations between the current codebase and requirements. Phase 14 renames are verified complete (`Tuple`, `tuple2`, `primitives`, `unquote_escaped`, `unquote_simple` are all in place). The codebase matches the PRD exactly.

---

## Open Questions

None. The scope is fully defined by the PRD and research documents. The dependency graph between the three code groups is well-understood and strictly layered. The edition 2024 module path convention is straightforward. Each sub-task is a mechanical code move with visibility adjustments. No architectural decisions are required.

---

## Commit Strategy

Per project conventions ("one issue category = one commit"), the entire module split goes into a single commit. Suggested commit message:

```
refactor: split parse.rs into parse/{combinators,domain,log}.rs sub-modules (PH-15)

Split the monolithic src/parse.rs (1762 lines) into a module directory
with three sub-module files. Constructor functions become pub(crate),
primitives module becomes pub(crate). Tests redistributed to per-module
test blocks. Module root provides pub use re-exports.
```

---

## File Summary

| File | Action | Estimated Lines |
|---|---|---|
| `src/parse.rs` | Rewrite as module root | ~8 lines |
| `src/parse/combinators.rs` | New file: combinators + combinator tests | ~880 lines |
| `src/parse/domain.rs` | New file: domain types + domain tests | ~370 lines |
| `src/parse/log.rs` | New file: log hierarchy + log tests | ~560 lines |
| `src/lib.rs` | No changes | 247 lines (unchanged) |
| `src/main.rs` | No changes | 71 lines (unchanged) |
