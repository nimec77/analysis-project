# PRD: Phase 10 — Box the Large Enum Variant

**Status:** PRD_READY
**Ticket:** PH-10 "Phase 10: Box the large enum variant"
**Phase:** 10 of 12 (see `docs/tasklist.md`)
**Dependencies:** None (independent phase)
**Blocked by:** Nothing
**Blocks:** None directly (downstream phases are independent)

---

## Context / Idea

Phase 10 targets the reduction of stack size for the `LogKind` enum hierarchy by boxing the oversized `AuthData` variant. The `AuthData` struct contains a fixed-size array of 1024 bytes (`[u8; AUTHDATA_SIZE]`), which inflates the size of every enum in the chain: `AppLogTraceKind` -> `AppLogKind` -> `LogKind` -> `LogLine`. Because Rust enums are sized to their largest variant, every `LogLine` — even a simple error or journal entry — carries 1024+ bytes of stack overhead due to the `Connect(AuthData)` variant in `AppLogTraceKind`.

The original author left two hints identifying this problem:

- `src/parse.rs:722` — `// подсказка: довольно много места на стэке` ("hint: quite a lot of space on the stack") on the `AuthData` struct definition
- `src/parse.rs:979` — `// подсказка: а поля не слишком много места на стэке занимают?` ("hint: don't the fields take up too much stack space?") on the `AppLogTraceKind` enum definition

### Authoritative specification from `docs/phase/phase-10.md`

**Goal:** Wrap `AuthData` (or whichever variant is oversized) in `Box<>` to reduce `LogKind` stack size.

**Tasks:**

- [ ] 10.1 Wrap `AuthData` (or whichever variant is oversized) in `Box<>` to reduce `LogKind` stack size
- [ ] 10.2 Adapt `test_authdata` and `test_log_kind` in `parse.rs`: wrap `AuthData(...)` in `Box::new(...)` in expected values where the variant is `Connect(Box<AuthData>)`

**Acceptance Criteria:** `cargo test && cargo run -- example.log`

**Dependencies:** None (independent phase)

**Implementation Notes:**

- **Hint:** `src/parse.rs:621` — `// подсказка: довольно много места на стэке` (note: actual line number in current codebase is 722)
- **Hint:** `src/parse.rs:852` — `// подсказка: а поля не слишком много места на стэке занимают?` (note: actual line number in current codebase is 979)

### Current codebase state (gap analysis)

The `AuthData` struct at line 725 of `src/parse.rs` holds a `[u8; 1024]` array:

```rust
const AUTHDATA_SIZE: usize = 1024;

// подсказка: довольно много места на стэке
/// Данные для авторизации
#[derive(Debug, Clone, PartialEq)]
pub struct AuthData([u8; AUTHDATA_SIZE]);
```

The `AppLogTraceKind` enum at line 982 has a `Connect(AuthData)` variant that directly embeds this 1024-byte struct:

```rust
// подсказка: а поля не слишком много места на стэке занимают?
/// Trace [приложения](AppLogKind)
#[derive(Debug, Clone, PartialEq)]
pub enum AppLogTraceKind {
    Connect(AuthData),       // <-- 1024 bytes
    SendRequest(String),     // <-- 24 bytes (3 * usize)
    Check(Announcements),    // <-- much smaller
    GetResponse(String),     // <-- 24 bytes
}
```

This size propagates upward through the enum hierarchy:
- `AppLogTraceKind` is ~1024 bytes (sized to the `Connect` variant)
- `AppLogKind` is ~1024 bytes (sized to the `Trace` variant which contains `AppLogTraceKind`)
- `LogKind` is ~1024 bytes (sized to the `App` variant which contains `AppLogKind`)
- `LogLine` is ~1028 bytes (contains `LogKind` + `request_id: u32`)

After boxing, `Connect(Box<AuthData>)` will reduce `AppLogTraceKind` to approximately the size of its next-largest variant (a `String` at 24 bytes, plus discriminant), bringing `LogLine` down from ~1028 bytes to ~32-40 bytes on the stack.

**Locations requiring changes:**

1. **`AppLogTraceKind::Connect` variant** (line 983): Change from `Connect(AuthData)` to `Connect(Box<AuthData>)`
2. **`Parsable` impl for `AppLogTraceKind`** (lines 1147-1201): The associated `Parser` type and `parser()` function must wrap the parsed `AuthData` in `Box::new()`. The type signature at line 1153 changes from `fn(AuthData) -> AppLogTraceKind` to `fn(Box<AuthData>) -> AppLogTraceKind`, and the closure at line 1181 changes from `|authdata| AppLogTraceKind::Connect(authdata)` to `|authdata| AppLogTraceKind::Connect(Box::new(authdata))`
3. **`test_log_kind` test** (line 1652): The expected value must change from `AppLogTraceKind::Connect(AuthData([...]))` to `AppLogTraceKind::Connect(Box::new(AuthData([...])))`
4. **Hint comments** (lines 722 and 979): Both `// подсказка:` comments should be removed after the fix is applied

---

## Goals

1. **Reduce the stack size of `AppLogTraceKind`** from ~1024 bytes to ~24-32 bytes by boxing the `AuthData` payload in the `Connect` variant, so that `Connect(Box<AuthData>)` stores a pointer instead of the full 1024-byte array inline.

2. **Propagate the size reduction** through the entire enum hierarchy (`AppLogKind`, `LogKind`, `LogLine`), so that all log line values stored in `Vec<LogLine>` are significantly smaller on the stack and in heap-allocated vectors.

3. **Update all test assertions** that construct or pattern-match on `Connect(AuthData(...))` to use `Connect(Box::new(AuthData(...)))`, so that all tests compile and pass with the new type.

4. **Remove the hint comments.** The `// подсказка: довольно много места на стэке` comment at line 722 and the `// подсказка: а поля не слишком много места на стэке занимают?` comment at line 979 should be removed, as the technical debt they identify will be resolved.

5. **Preserve all existing behavior.** The boxing is purely a memory layout change. All parsing, filtering, and output must remain identical. All existing tests must pass.

---

## User Stories

1. **As a maintainer of the log parser**, I want the `LogKind` enum hierarchy to have a reasonable stack size, so that vectors of `LogLine` do not waste ~1000 bytes per element on padding driven by a single rarely-used variant.

2. **As a Rust developer reading this codebase**, I want the oversized variant to be explicitly boxed, so that the `#[warn(variant_size_differences)]` lint (if enabled) does not fire, and the design intent of heap-allocating large payloads is visible in the type definition.

3. **As a contributor adding new enum variants**, I want a precedent for boxing large payloads, so that future additions to the enum hierarchy follow the same pattern and do not silently inflate stack usage.

---

## Scenarios

### Scenario 1: `AppLogTraceKind::Connect` variant boxed

**Before:**
```rust
pub enum AppLogTraceKind {
    Connect(AuthData),          // 1024 bytes inline
    SendRequest(String),
    Check(Announcements),
    GetResponse(String),
}
```

**After:**
```rust
pub enum AppLogTraceKind {
    Connect(Box<AuthData>),     // 8 bytes (pointer) inline; 1024 bytes on heap
    SendRequest(String),
    Check(Announcements),
    GetResponse(String),
}
```

### Scenario 2: Parser closure updated to box the value

**Before:**
```rust
map(
    preceded(
        strip_whitespace(tag("Connect")),
        strip_whitespace(AuthData::parser()),
    ),
    |authdata| AppLogTraceKind::Connect(authdata),
)
```

**After:**
```rust
map(
    preceded(
        strip_whitespace(tag("Connect")),
        strip_whitespace(AuthData::parser()),
    ),
    |authdata| AppLogTraceKind::Connect(Box::new(authdata)),
)
```

The associated `Parser` type in the `Parsable` impl must also be updated to reflect the changed function signature (`fn(AuthData) -> AppLogTraceKind` becomes a closure type or the map function pointer type is adjusted accordingly).

### Scenario 3: `test_log_kind` expected value updated

**Before:**
```rust
AppLogTraceKind::Connect(AuthData([0x30, 0xc3, ...]))
```

**After:**
```rust
AppLogTraceKind::Connect(Box::new(AuthData([0x30, 0xc3, ...])))
```

### Scenario 4: Hint comments removed

**Before:**
```rust
// подсказка: довольно много места на стэке
/// Данные для авторизации
#[derive(Debug, Clone, PartialEq)]
pub struct AuthData([u8; AUTHDATA_SIZE]);
```

**After:**
```rust
/// Данные для авторизации
#[derive(Debug, Clone, PartialEq)]
pub struct AuthData([u8; AUTHDATA_SIZE]);
```

And similarly, the `// подсказка: а поля не слишком много места на стэке занимают?` comment above `AppLogTraceKind` is removed.

---

## Metrics

| Metric | Target |
|---|---|
| `cargo test` | All tests pass (no test cases deleted) |
| `cargo run -- example.log` | Output identical to pre-refactoring |
| `std::mem::size_of::<AppLogTraceKind>()` | Reduced from ~1032 bytes to ~32-40 bytes |
| `std::mem::size_of::<LogLine>()` | Reduced from ~1040 bytes to ~40-48 bytes |
| `Connect` variant | Uses `Box<AuthData>` instead of inline `AuthData` |
| Hint comment `подсказка: довольно много места на стэке` | Removed |
| Hint comment `подсказка: а поля не слишком много места на стэке занимают?` | Removed |

---

## Constraints

1. **Zero external dependencies.** No new crates in `Cargo.toml`.
2. **No behavior changes.** The boxing is purely a memory layout optimization. All parsing, filtering, and output must remain identical.
3. **No test deletions.** Existing tests are updated to use `Box::new(...)` in expected values but are not deleted or reduced in coverage.
4. **Scope boundary.** This phase changes only `AppLogTraceKind::Connect` and its associated parser and tests. The `AuthData` struct itself is not changed (it remains `pub struct AuthData([u8; AUTHDATA_SIZE])`). Other enum variants are not boxed unless they are also identified as oversized.
5. **Public API consideration.** `AppLogTraceKind` is a public type. The variant change from `Connect(AuthData)` to `Connect(Box<AuthData>)` is a breaking change for any external pattern-matching code. This is acceptable for this internal refactoring project.
6. **Parser type signature.** The `Parsable` impl for `AppLogTraceKind` uses explicit associated types. The `Parser` type must be updated to reflect the `Box<AuthData>` wrapping, which may require changing the function pointer type in the `Map` combinator from `fn(AuthData) -> AppLogTraceKind` to a compatible type.

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Parser type signature complexity: the `Parsable` impl for `AppLogTraceKind` uses fully spelled-out associated types including `fn(AuthData) -> AppLogTraceKind`. Adding `Box::new()` in the closure may prevent using a function pointer type, requiring a closure type or a named wrapper function. | Medium | Low | Use a named function `fn connect_boxed(authdata: AuthData) -> AppLogTraceKind { AppLogTraceKind::Connect(Box::new(authdata)) }` if a function pointer is needed, or restructure the `Map` combinator to accept closures in the type position. Alternatively, keep the map function signature as `fn(AuthData) -> AppLogTraceKind` and have the function body perform the boxing. |
| Heap allocation overhead: every `Connect` log entry now requires a heap allocation for the `Box<AuthData>`. | Low | Low | The `Connect` variant contains 1024 bytes of auth data that is already being parsed from a string and copied. A single heap allocation is negligible compared to the I/O and parsing cost. The benefit of reducing all other `LogLine` instances from ~1040 bytes to ~40 bytes far outweighs this cost. |
| Pattern-matching in `src/lib.rs`: if any `match` arms in `read_log()` destructure `Connect(authdata)`, they will need to be updated to `Connect(boxed_authdata)` or use `Connect(ref authdata)`. | Low | Low | The current `read_log()` filtering logic does not destructure `Connect` — it uses `matches!()` macros that only check the variant shape, not the inner data. No changes to `src/lib.rs` are expected. |

---

## Open Questions

None. The phase specification is complete, the scope is well-defined, and the implementation path is clear. The single change — wrapping `AuthData` in `Box<>` at the `Connect` variant — has well-understood implications for the parser type signature and test assertions.

---

## Files Affected

| File | Changes |
|---|---|
| `src/parse.rs` | Change `AppLogTraceKind::Connect(AuthData)` to `Connect(Box<AuthData>)` (line 983). Update the `Parsable` impl for `AppLogTraceKind` to wrap the parsed `AuthData` in `Box::new()` (lines 1147-1201). Update `test_log_kind` expected value to use `Box::new(AuthData(...))` (line 1652). Remove hint comments at lines 722 and 979. |
