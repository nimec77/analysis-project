# PRD: Phase 13 — Bug fix + dead code cleanup

**Status:** PRD_READY
**Ticket:** PH-13 "Phase 13: Bug fix + dead code cleanup"
**Phase:** 13 of 22 (see `docs/vision.md`)
**Dependencies:** None (standalone phase)
**Blocked by:** Nothing
**Blocks:** None

---

## Context / Idea

Phase 13 fixes a parsing bug in `WithdrawCash` and removes all unused code (dead types, unused constructors) from `src/parse.rs`.

This is the first phase in the optimization and improvement track (phases 13-22). It addresses a correctness issue that must be resolved before further refactoring proceeds.

### Authoritative specification from `docs/phase/phase-13.md`

**Goal:** Fix the `WithdrawCash` parsing bug and remove all unused code (dead types, unused constructors).

**Tasks:**

- [ ] 13.1 Fix `WithdrawCash` bug: `src/parse.rs:1320` maps to `DepositCash` instead of `WithdrawCash`
- [ ] 13.2 Add dedicated `WithdrawCash` parsing test to prevent regression
- [ ] 13.3 Remove unused `AsIs` struct + Parser impl (~line 138)
- [ ] 13.4 Remove unused `Either<L,R>` enum (~line 731)
- [ ] 13.5 Remove unused `Status` enum + Parsable impl (~line 737)
- [ ] 13.6 Remove unused `all3()` constructor (~line 331)
- [ ] 13.7 Remove unused `all4()` constructor (~line 356)

**Acceptance Criteria:** `cargo test && cargo run -- example.log`

**Dependencies:** None (standalone phase)

**Implementation Notes:**

- The `WithdrawCash` bug at line 1320 incorrectly maps to `DepositCash` -- this is a copy-paste error
- Dead code items (`AsIs`, `Either`, `Status`, `all3`, `all4`) should be confirmed unused before removal
- Line numbers are approximate and may have shifted from earlier refactoring phases

### Current codebase state (gap analysis)

**Bug at `src/parse.rs:1320`:** The `WithdrawCash` parser arm correctly parses the `"WithdrawCash"` tag and a `UserCash` payload, but the mapping closure produces `AppLogJournalKind::DepositCash(user_cash)` instead of `AppLogJournalKind::WithdrawCash(user_cash)`. This is a copy-paste error from the `DepositCash` arm immediately above (lines 1314-1316). The result is that any `WithdrawCash` journal entry is silently misclassified as `DepositCash` in the parsed output.

```rust
// Line 1314-1316: DepositCash arm (correct)
map(
    preceded(strip_whitespace(tag("DepositCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::DepositCash(user_cash),
),
// Line 1318-1321: WithdrawCash arm (BUG — maps to DepositCash)
map(
    preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::DepositCash(user_cash),  // <-- should be WithdrawCash
),
```

**Dead code — `AsIs` struct (line 138):** A parser struct that consumes the entire remaining input and returns it as a `String`. Defined at line 138 with its `Parser` impl at line 139-143. Not referenced anywhere else in the codebase (no call sites, no tests, no type references).

**Dead code — `Either<Left, Right>` enum (line 731):** A generic two-variant enum. Defined at line 731-734. Not referenced anywhere else in the codebase. The parser combinators use `Alt` instead.

**Dead code — `Status` enum (line 737):** An enum with `Ok` and `Err(String)` variants, plus a `Parsable` impl (lines 741-758). Not referenced anywhere else in the codebase. No parser uses `Status` as a component.

**Dead code — `all3()` constructor (line 331):** A convenience constructor for `All<(A0, A1, A2)>`. Defined at line 331-335. Not called anywhere in the codebase. The `All` struct can still be constructed directly where needed.

**Dead code — `all4()` constructor (line 356):** A convenience constructor for `All<(A0, A1, A2, A3)>`. Defined at line 356-364. Not called anywhere in the codebase. The `All` struct can still be constructed directly where needed.

---

## Goals

1. **Fix the `WithdrawCash` parsing bug.** Change the mapping closure at line 1320 from `AppLogJournalKind::DepositCash(user_cash)` to `AppLogJournalKind::WithdrawCash(user_cash)` so that `WithdrawCash` journal entries are correctly classified.

2. **Add a dedicated `WithdrawCash` parsing test.** Write a test that parses a log line containing `App::Journal WithdrawCash ...` and asserts that the result is `AppLogJournalKind::WithdrawCash(_)`, not `DepositCash(_)`. This prevents regression of the copy-paste bug.

3. **Remove the unused `AsIs` struct and its `Parser` impl.** Delete the `AsIs` struct definition (line 138), its `#[derive]` attribute (line 137), its doc comment (line 136), and the `impl Parser for AsIs` block (lines 139-143).

4. **Remove the unused `Either<Left, Right>` enum.** Delete the `Either` enum definition (lines 731-734) and its doc comment (line 730).

5. **Remove the unused `Status` enum and its `Parsable` impl.** Delete the `Status` enum definition (lines 737-740), its doc comment (line 736), and the `impl Parsable for Status` block (lines 741-758).

6. **Remove the unused `all3()` constructor function.** Delete the `all3` function definition (lines 329-335), including its doc comments (lines 329-330).

7. **Remove the unused `all4()` constructor function.** Delete the `all4` function definition (lines 354-364), including its doc comments (lines 354-355).

8. **Preserve all existing behavior.** Aside from the bug fix (which corrects incorrect behavior), all parsing, filtering, and output must remain identical. All existing tests must pass.

---

## User Stories

1. **As a user analyzing log files with `WithdrawCash` events**, I want `WithdrawCash` journal entries to be correctly classified so that filtering by `ReadMode::Exchanges` produces accurate results and `WithdrawCash` events are distinguishable from `DepositCash` events in the output.

2. **As a maintainer of the parser**, I want a dedicated test for `WithdrawCash` parsing so that this copy-paste bug cannot regress silently in future refactoring.

3. **As a developer reading `src/parse.rs`**, I want unused types (`AsIs`, `Either`, `Status`) and unused constructors (`all3`, `all4`) removed so that the codebase only contains code that is actively used, reducing cognitive load and false leads when navigating the parser module.

4. **As a contributor adding new features**, I want dead code eliminated so that I do not mistakenly depend on unused types that may have stale or incorrect implementations.

---

## Scenarios

### Scenario 1: `WithdrawCash` bug fix

**Before (`src/parse.rs:1318-1321`):**
```rust
map(
    preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::DepositCash(user_cash),
),
```

**After (`src/parse.rs:1318-1321`):**
```rust
map(
    preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::WithdrawCash(user_cash),
),
```

A single token change: `DepositCash` becomes `WithdrawCash` in the mapping closure.

### Scenario 2: `WithdrawCash` regression test

A new test is added that parses a line like:

```
App::Journal WithdrawCash UserCash{"user_id":"Alice","cash":500,} requestid=11
```

and asserts the parsed result contains `AppLogJournalKind::WithdrawCash(_)`.

### Scenario 3: Dead code removal — `AsIs`

**Before:** Lines 136-144 contain the `AsIs` struct, its `#[derive]`, doc comment, and `impl Parser for AsIs` block.

**After:** All of lines 136-144 are deleted. No replacement code.

### Scenario 4: Dead code removal — `Either`

**Before:** Lines 730-734 contain the `Either<Left, Right>` enum and its doc comment.

**After:** All of lines 730-734 are deleted. No replacement code.

### Scenario 5: Dead code removal — `Status`

**Before:** Lines 736-758 contain the `Status` enum, its doc comment, and the `impl Parsable for Status` block.

**After:** All of lines 736-758 are deleted. No replacement code.

### Scenario 6: Dead code removal — `all3()`

**Before:** Lines 329-335 contain the `all3()` function and its doc comments.

**After:** All of lines 329-335 are deleted. No replacement code. The `All<(A0, A1, A2)>` `Parser` impl (above these lines) is retained as it may be used by direct construction.

### Scenario 7: Dead code removal — `all4()`

**Before:** Lines 354-364 contain the `all4()` function and its doc comments.

**After:** All of lines 354-364 are deleted. No replacement code. The `All<(A0, A1, A2, A3)>` `Parser` impl is retained as it may be used by direct construction.

---

## Metrics

| Metric | Target |
|---|---|
| `cargo test` | All tests pass (no test cases deleted) |
| `cargo run -- example.log` | Output identical to pre-phase (no `WithdrawCash` entries in `example.log` to change output) |
| `WithdrawCash` mapping in parser | Maps to `AppLogJournalKind::WithdrawCash` (not `DepositCash`) |
| `WithdrawCash` regression test | Present and passing |
| `AsIs` struct in `src/parse.rs` | Deleted |
| `Either` enum in `src/parse.rs` | Deleted |
| `Status` enum + `Parsable` impl in `src/parse.rs` | Deleted |
| `all3()` function in `src/parse.rs` | Deleted |
| `all4()` function in `src/parse.rs` | Deleted |
| New compiler warnings from dead code | Zero (all dead code removed) |

---

## Constraints

1. **Zero external dependencies.** No new crates in `Cargo.toml`. Per `docs/vision.md`, third-party crates are allowed starting from phase 13, but this phase does not require any.
2. **No behavior changes beyond the bug fix.** The `WithdrawCash` fix corrects incorrect behavior (a bug). All other parsing, filtering, and output must remain identical.
3. **No test deletions.** Existing tests are not deleted or reduced in coverage. New test(s) are added for `WithdrawCash`.
4. **Confirm dead code is unused before removal.** Each item (`AsIs`, `Either`, `Status`, `all3`, `all4`) must be verified to have no references outside its definition before deletion.
5. **Scope boundary.** This phase modifies only `src/parse.rs`. No changes to `src/lib.rs` or `src/main.rs` are expected.
6. **One issue category = one commit.** Per project conventions, the bug fix and the dead code cleanup are separate issue categories and should be separate commits (or can be combined if the project treats this phase as a single issue category).

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| The `WithdrawCash` bug fix changes output for log files containing `WithdrawCash` entries. | Certain | Low | This is the intended correction. The `example.log` file does not contain `WithdrawCash` entries, so `cargo run -- example.log` output is unchanged. The fix is verified by the new regression test. |
| Removing `AsIs`, `Either`, `Status`, `all3`, or `all4` causes a compilation error if they are referenced somewhere not found by grep. | Very Low | Low | All items were confirmed unused via project-wide search. `cargo build` after removal will immediately surface any missed references. |
| The `All<(A0, A1, A2)>` or `All<(A0, A1, A2, A3)>` `Parser` impls (distinct from the `all3`/`all4` constructor functions) might be unused after removing the constructors. | Low | Low | The `Parser` trait impls for these tuple arities should be retained — they are generic implementations that may be used via direct `All { parser: (...) }` construction. Removing them is out of scope for this phase. |
| Line numbers in `docs/phase/phase-13.md` have shifted from earlier phases. | Certain | None | The phase description itself notes that line numbers are approximate. Actual items are located by name/pattern, not by line number. |

---

## Open Questions

None. The phase specification is complete, the scope is well-defined, and all items have been located and verified in the current codebase. The bug fix is a single-token change, the regression test is straightforward, and all dead code items are confirmed unused.

---

## Files Affected

| File | Changes |
|---|---|
| `src/parse.rs` | Fix `WithdrawCash` mapping at line 1320: change `AppLogJournalKind::DepositCash(user_cash)` to `AppLogJournalKind::WithdrawCash(user_cash)`. Remove `AsIs` struct + `Parser` impl (lines 136-144). Remove `Either<L,R>` enum (lines 730-734). Remove `Status` enum + `Parsable` impl (lines 736-758). Remove `all3()` function (lines 329-335). Remove `all4()` function (lines 354-364). Add `WithdrawCash` parsing test in the `#[cfg(test)]` module. |
