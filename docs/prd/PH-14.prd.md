# PRD: Phase 14 — Naming improvements

**Status:** PRD_READY
**Ticket:** PH-14 "Phase 14: Naming improvements"
**Phase:** 14 of 22 (see `docs/vision.md`)
**Dependencies:** None (standalone phase)
**Blocked by:** Nothing
**Blocks:** Phase 15 (module split — cleaner names before splitting yields a cleaner result)

---

## Context / Idea

Phase 14 improves naming consistency across the parser module (`src/parse.rs`) to better communicate intent and align with established conventions (e.g., nom naming). This phase renames five items: the `All` struct, its constructor `all2()`, the `stdp` module, and two internal unquote functions. No behavior changes — purely renaming and updating all references.

This phase is positioned immediately before phase 15 (module split) so that the renamed identifiers are in place before the code is distributed across sub-modules.

### Authoritative specification from `docs/phase/phase-14.md`

**Goal:** Improve naming consistency across the parser module to better communicate intent and align with established conventions (e.g., nom naming).

**Tasks:**

- [ ] 14.1 Rename `All` struct to `Tuple` (matches nom's naming for sequential parsing returning a tuple)
- [ ] 14.2 Rename `all2()` to `tuple2()` and update all call sites
- [ ] 14.3 Rename `stdp` module to `primitives`
- [ ] 14.4 Rename `do_unquote()` to `unquote_escaped()`
- [ ] 14.5 Rename `do_unquote_non_escaped()` to `unquote_simple()`
- [ ] 14.6 Update all internal references and tests

**Acceptance Criteria:** `cargo test && cargo run -- example.log`

**Dependencies:** None (standalone phase)

**Implementation Notes:**

Not changing: `A0/A1/A2` type params (standard tuple-impl pattern), `nz()` test helper, `AssetDsc.dsc` (matches domain key), arity suffixes (`alt2`, `permutation3`).

### Current codebase state (gap analysis)

**`All` struct (line 282):** Currently named `All<T>` with a `parser: T` field. Used in 14 locations across `src/parse.rs`: the struct definition, two `Parser` trait impls (for 2-tuple and 3-tuple arities), the `all2()` constructor, and 10 type annotations in `Parsable` impl return types (e.g., `All<(StripWhitespace<QuotedTag>, StripWhitespace<Tag>)>`). The doc comment at line 280 already references nom's `all` combinator. Renaming to `Tuple` aligns with nom's actual naming convention where `tuple()` is the combinator for sequential parsing that returns a tuple.

**`all2()` function (line 301):** Constructor for `All<(A0, A1)>`. Called at 8 call sites throughout the parser implementations (lines 362, 722, 751, 780, 812, 847, 1330, 1491). Renaming to `tuple2()` follows the same arity-suffix pattern already used by `alt2()..alt8()` and `permutation2()..permutation3()`.

**`stdp` module (line 14):** Internal module containing parsers for standard/primitive types (`U32`, `I32`, `Byte`). The name `stdp` is an abbreviation that does not communicate its purpose. Referenced 39 times across `src/parse.rs` as `stdp::U32`, `stdp::I32`, `stdp::Byte`. Renaming to `primitives` makes the module's purpose self-evident.

**`do_unquote()` function (line 93):** Parses a quoted string with backslash escape handling (e.g., `\"` and `\\`). Returns `Result<(&str, String), ()>` because escaped characters require building a new owned string. Referenced at line 129 (called from the `Unquote` parser's `parse` method). The `do_` prefix is a naming anti-pattern that adds no semantic value. Renaming to `unquote_escaped()` clearly communicates that this function handles escape sequences.

**`do_unquote_non_escaped()` function (line 115):** A simplified unquoting function that does not handle escape sequences — it finds the next `"` and returns the slice between quotes. Returns `Result<(&str, &str), ()>` (borrows, no allocation). Referenced at line 158 (called from `QuotedTag`'s parse method) and in 3 test assertions (lines 1389-1391). Renaming to `unquote_simple()` clearly communicates the simpler behavior compared to `unquote_escaped()`.

**Doc comments referencing old names:** The doc comment at line 114 references `[do_unquote]` as an intra-doc link. This reference must be updated to `[unquote_escaped]`. Similarly, the doc comment at line 280 references `all` from nom and the constructor doc at line 299 references `[All]` — both must be updated to reference `Tuple` and `tuple`.

---

## Goals

1. **Rename `All` struct to `Tuple`.** Change the struct definition at line 282 and all 14 references throughout `src/parse.rs` (struct definition, `Parser` trait impls for 2-tuple and 3-tuple arities, type annotations in `Parsable` return types, doc comments). This aligns with nom's `tuple` combinator naming.

2. **Rename `all2()` to `tuple2()`.** Change the function definition at line 301 and all 8 call sites. Update the doc comment at line 299 to reference `[Tuple]` instead of `[All]`.

3. **Rename the `stdp` module to `primitives`.** Change the module declaration at line 14 and all 39 references (`stdp::U32`, `stdp::I32`, `stdp::Byte`) to use `primitives::U32`, `primitives::I32`, `primitives::Byte`.

4. **Rename `do_unquote()` to `unquote_escaped()`.** Change the function definition at line 93 and the call site at line 129. Update the doc comment at line 91 accordingly.

5. **Rename `do_unquote_non_escaped()` to `unquote_simple()`.** Change the function definition at line 115, the call site at line 158, the 3 test references (lines 1389-1391), and the intra-doc link at line 114 to reference `[unquote_escaped]` instead of `[do_unquote]`.

6. **Update all internal references and tests.** Every occurrence of the old names (in code, type signatures, doc comments, and test functions) must be updated. No old name should remain after this phase.

7. **Preserve all existing behavior.** This is a pure renaming refactor. Same input must produce same output. All existing tests must continue to pass without modification beyond the renames.

---

## User Stories

1. **As a developer reading `src/parse.rs`**, I want the `All` struct to be named `Tuple` so that its purpose (sequential parsing that returns a tuple of results) is immediately clear and consistent with the nom combinator naming convention I may already know.

2. **As a developer reading `src/parse.rs`**, I want the `stdp` module to be named `primitives` so that I can understand at a glance that it contains parsers for primitive/standard types without having to look inside the module.

3. **As a developer reading the unquote functions**, I want `do_unquote()` to be named `unquote_escaped()` and `do_unquote_non_escaped()` to be named `unquote_simple()` so that the naming clearly communicates the distinction: one handles escape sequences (and allocates), the other does not.

4. **As a contributor navigating the parser module**, I want naming conventions to be consistent across the codebase so that `tuple2()` follows the same arity-suffix pattern as `alt2()`, `permutation2()`, etc.

---

## Scenarios

### Scenario 1: Rename `All` to `Tuple`

**Before:**
```rust
/// (аналог `all` из `nom`)
#[derive(Debug, Clone)]
pub struct All<T> {
    parser: T,
}
impl<A0, A1> Parser for All<(A0, A1)> { ... }
```

**After:**
```rust
/// (аналог `tuple` из `nom`)
#[derive(Debug, Clone)]
pub struct Tuple<T> {
    parser: T,
}
impl<A0, A1> Parser for Tuple<(A0, A1)> { ... }
```

All type annotations referencing `All<(...)>` in `Parsable` impl return types become `Tuple<(...)>`.

### Scenario 2: Rename `all2()` to `tuple2()`

**Before:**
```rust
/// Конструктор [All] для двух парсеров
fn all2<A0: Parser, A1: Parser>(a0: A0, a1: A1) -> All<(A0, A1)> {
    All { parser: (a0, a1) }
}
```

**After:**
```rust
/// Конструктор [Tuple] для двух парсеров
fn tuple2<A0: Parser, A1: Parser>(a0: A0, a1: A1) -> Tuple<(A0, A1)> {
    Tuple { parser: (a0, a1) }
}
```

All 8 call sites change from `all2(...)` to `tuple2(...)`.

### Scenario 3: Rename `stdp` module to `primitives`

**Before:**
```rust
mod stdp {
    // parsers for std types
    ...
}
```

**After:**
```rust
mod primitives {
    // parsers for primitive types
    ...
}
```

All 39 references change from `stdp::U32`, `stdp::I32`, `stdp::Byte` to `primitives::U32`, `primitives::I32`, `primitives::Byte`.

### Scenario 4: Rename `do_unquote()` to `unquote_escaped()`

**Before:**
```rust
fn do_unquote(input: &str) -> Result<(&str, String), ()> { ... }
```

**After:**
```rust
fn unquote_escaped(input: &str) -> Result<(&str, String), ()> { ... }
```

The call site at line 129 changes from `do_unquote(input)` to `unquote_escaped(input)`.

### Scenario 5: Rename `do_unquote_non_escaped()` to `unquote_simple()`

**Before:**
```rust
/// (сокращённая версия [do_unquote], в которой вложенные кавычки не предусмотрены)
fn do_unquote_non_escaped(input: &str) -> Result<(&str, &str), ()> { ... }
```

**After:**
```rust
/// (сокращённая версия [unquote_escaped], в которой вложенные кавычки не предусмотрены)
fn unquote_simple(input: &str) -> Result<(&str, &str), ()> { ... }
```

The call site at line 158, plus 3 test assertions (lines 1389-1391), change from `do_unquote_non_escaped(...)` to `unquote_simple(...)`.

---

## Metrics

| Metric | Target |
|---|---|
| `cargo test` | All tests pass (no test cases deleted) |
| `cargo run -- example.log` | Output identical to pre-phase |
| `All` in `src/parse.rs` | Zero occurrences (all renamed to `Tuple`) |
| `all2` in `src/parse.rs` | Zero occurrences (all renamed to `tuple2`) |
| `stdp` in `src/parse.rs` | Zero occurrences (all renamed to `primitives`) |
| `do_unquote` in `src/parse.rs` | Zero occurrences (renamed to `unquote_escaped`) |
| `do_unquote_non_escaped` in `src/parse.rs` | Zero occurrences (renamed to `unquote_simple`) |
| Compiler warnings | Zero new warnings |
| Behavior change | None — pure rename refactor |

---

## Constraints

1. **Zero external dependencies.** No new crates in `Cargo.toml`.
2. **No behavior changes.** Same input must produce same output. This is a pure renaming refactor.
3. **No test deletions.** Existing tests are not deleted or reduced in coverage. Test code is updated only to reflect the new names.
4. **Scope boundary.** This phase modifies only `src/parse.rs`. No changes to `src/lib.rs` or `src/main.rs` are expected (neither file references the renamed items directly).
5. **Not changing.** The following names are explicitly out of scope per the phase description: `A0`/`A1`/`A2` type parameters (standard tuple-impl pattern), `nz()` test helper, `AssetDsc.dsc` field (matches domain key), arity suffixes on other combinators (`alt2`, `permutation3`).
6. **One issue category = one commit.** Per project conventions, this entire phase is a single naming-improvement issue category and can be a single commit.
7. **Doc comments.** Intra-doc links referencing old names (e.g., `[All]`, `[do_unquote]`) must be updated to reference the new names (`[Tuple]`, `[unquote_escaped]`). Existing Russian comments are left as-is (text is updated only where identifier names appear within comments).

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| A reference to an old name is missed, causing a compilation error. | Low | Low | Each rename is a simple find-and-replace within a single file (`src/parse.rs`). `cargo build` will immediately surface any missed references. Occurrence counts are known: `All` (14), `all2` (9), `stdp` (39), `do_unquote` (5), `do_unquote_non_escaped` (5). |
| The `All` struct or `stdp` module is referenced from `src/lib.rs` or `src/main.rs`. | Very Low | Low | Verified via grep: neither `All` nor `stdp` appears in `lib.rs` or `main.rs`. The `All` struct is `pub` but only used within `parse.rs`. |
| Renaming `All` to `Tuple` conflicts with `std::tuple` or a Rust keyword. | None | N/A | `Tuple` is not a keyword in Rust. There is no `std::tuple` module. The struct is in the `parse` module's local scope — no conflict. |
| Doc comments with intra-doc links break. | Low | Very Low | Intra-doc links like `[All]` and `[do_unquote]` are updated as part of the rename. `cargo doc` (if run) would catch broken links. |
| Merge conflicts with phase 13 changes. | Low | Low | Phase 13 removed dead code (`all3`, `all4`, `AsIs`, `Either`, `Status`) and fixed the `WithdrawCash` bug. These removals do not conflict with the renames in phase 14 since the removed items no longer exist. |

---

## Open Questions

None. The phase specification is complete, the scope is well-defined, and all items to be renamed have been located and counted in the current codebase. Each rename is a mechanical find-and-replace within a single file. The "not changing" list explicitly excludes items that might otherwise be ambiguous.

---

## Files Affected

| File | Changes |
|---|---|
| `src/parse.rs` | Rename `All` struct to `Tuple` (14 occurrences). Rename `all2()` to `tuple2()` (9 occurrences: 1 definition + 8 call sites). Rename `stdp` module to `primitives` (39 occurrences: 1 module declaration + 38 qualified references). Rename `do_unquote()` to `unquote_escaped()` (5 occurrences: 1 definition + 1 call site + doc comment references). Rename `do_unquote_non_escaped()` to `unquote_simple()` (5 occurrences: 1 definition + 1 call site + 3 test references). Update all doc comments containing old identifier names. |
