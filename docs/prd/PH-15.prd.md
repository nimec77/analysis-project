# PRD: Phase 15 — Modularity (split `parse.rs`)

**Status:** PRD_READY
**Ticket:** PH-15 "Phase 15: Modularity (split parse.rs)"
**Phase:** 15 of 22 (see `docs/vision.md`)
**Dependencies:** Phase 14 complete
**Blocked by:** Phase 14 (naming improvements — cleaner names before splitting yields a cleaner result)
**Blocks:** Phase 16 (newtype pattern — smaller files are easier to refactor)

---

## Context / Idea

Phase 15 splits the monolithic `src/parse.rs` (1762 lines) into a module directory with separate files for combinators, domain types, and log hierarchy. This improves navigability, reduces cognitive load, and prepares the codebase for further refactoring in subsequent phases (newtypes, error handling, strategy pattern).

The project uses Rust edition 2024, which supports the modern module path convention (`src/parse/combinators.rs`) without requiring `mod.rs` files. The current `src/parse.rs` contains three logically distinct groups of code that are interleaved:

1. **Combinator framework** (lines 1-686): `Parser` and `Parsable` traits, the `primitives` sub-module, all combinator structs (`Tag`, `Alt`, `Map`, `Delimited`, `Tuple`, `Preceded`, `Permutation`, `List`, `Take`, `StripWhitespace`, `KeyValue`, `Unquote`, `QuotedTag`), their constructors, and helper functions (`quote`, `unquote_escaped`, `unquote_simple`).
2. **Domain types** (lines 688-877): `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements`, and the generic `just_parse` entry point. Each type has a `Parsable` impl that constructs its parser declaratively.
3. **Log hierarchy** (lines 879-1345): `LogLine`, `LogKind`, `SystemLogKind`, `SystemLogTraceKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogTraceKind`, `AppLogJournalKind`, and all their `Parsable` impls.
4. **Tests** (lines 1347-1762): A single `#[cfg(test)] mod test` block containing tests for all three groups.

### Authoritative specification from `docs/phase/phase-15.md`

**Goal:** Split the monolithic `src/parse.rs` into a module directory with separate files for combinators, domain types, and log hierarchy.

**Tasks:**

- [ ] 15.1 Create `src/parse/` directory
- [ ] 15.2 Move combinator framework (traits + structs) to `src/parse/combinators.rs`
- [ ] 15.3 Move domain types (AuthData, AssetDsc, Backet, etc.) to `src/parse/domain.rs`
- [ ] 15.4 Move log hierarchy (LogLine, LogKind, etc.) to `src/parse/log.rs`
- [ ] 15.5 Convert `src/parse.rs` to module root: `mod combinators; mod domain; mod log;` with `pub use` re-exports
- [ ] 15.6 Move `primitives` (ex-`stdp`) as private sub-module within `combinators.rs`
- [ ] 15.7 Refine visibility: constructor functions to `pub(crate)`
- [ ] 15.8 Move tests to `#[cfg(test)] mod tests` in each sub-module

**Acceptance Criteria:** `cargo test && cargo run -- example.log`

**Dependencies:** Phase 14 complete

**Implementation Notes:** Uses edition 2024 module paths (NO `mod.rs`).

### Current codebase state (gap analysis)

**`src/parse.rs` (1762 lines):** Currently a single monolithic file containing all parser infrastructure, domain types, log hierarchy types, and tests. Phase 14 renames are complete (confirmed: `Tuple`, `tuple2`, `primitives`, `unquote_escaped`, `unquote_simple` are all in place).

**Combinator framework (lines 1-686, ~686 lines):** Contains the `Parser` trait (line 3), `Parsable` trait (line 9), `mod primitives` (lines 14-74, containing `U32`, `I32`, `Byte`), helper functions `quote` (line 77), `unquote_escaped` (line 93), `unquote_simple` (line 115), and 13 combinator structs with their `Parser` impls and constructor functions: `Unquote` (line 125), `Tag` (line 139), `QuotedTag` (line 154), `StripWhitespace` (line 171), `Delimited` (line 194), `Map` (line 234), `Preceded` (line 253), `Tuple` (line 282), `KeyValue` (line 342), `Permutation` (line 376), `List` (line 477), `Alt` (line 511), `Take` (line 666). Also includes the `AUTHDATA_SIZE` constant (line 688) which is used by `AuthData` in the domain layer.

**Domain types (lines 688-877, ~190 lines):** Contains `AuthData` (line 692), `AssetDsc` (line 704), `Backet` (line 735), `UserCash` (line 764), `UserBacket` (line 796), `UserBackets` (line 828), `Announcements` (line 863), and the generic `just_parse` function (line 875). Each struct definition is immediately followed by its `Parsable` impl. These types depend on combinator types for their `Parsable::Parser` associated type annotations (e.g., `Map<Delimited<Tuple<...>, ...>, ...>`).

**Log hierarchy (lines 879-1345, ~467 lines):** Contains 9 enum/struct definitions: `LogKind` (line 881), `SystemLogKind` (line 887), `SystemLogTraceKind` (line 893), `SystemLogErrorKind` (line 899), `AppLogKind` (line 905), `AppLogErrorKind` (line 912), `AppLogTraceKind` (line 918), `AppLogJournalKind` (line 926), `LogLine` (line 1324). Each enum definition is followed by its `Parsable` impl. The log types depend on both combinator types (for parser type annotations) and domain types (e.g., `AppLogJournalKind` references `UserCash`, `UserBacket`, `AuthData`, `Announcements`).

**Tests (lines 1347-1762, ~415 lines):** A single `#[cfg(test)] mod test` block. Tests cover all three categories: primitive parsers (`test_u32`, `test_i32`), combinator infrastructure (`test_quote`, `test_unquote_simple`, `test_unquote`, `test_tag`, `test_quoted_tag`, `test_strip_whitespace`, `test_delimited`, `test_key_value`, `test_list`), domain types (`test_authdata`, `test_asset_dsc`, `test_backet`, `test_just_parse_*`), and log hierarchy (`test_log_kind`, `test_withdraw_cash`).

**`src/lib.rs` imports:** Line 1 declares `pub mod parse;`, line 2 uses `use parse::*;`. The library crate references `LogLine`, `Parsable`, `LogKind`, `SystemLogKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogJournalKind`, and `SystemLogErrorKind` (via pattern matching in `read_log()`). All of these are currently `pub` items in `parse.rs`. The `pub use` re-exports in the new module root must preserve this public API.

**Visibility analysis:** Currently, combinator structs are `pub` (e.g., `pub struct Tag`, `pub struct Tuple<T>`, `pub struct Alt<T>`), but constructor functions are private (e.g., `fn tag(...)`, `fn tuple2(...)`, `fn alt2(...)`). The constructors are only called within `parse.rs` (specifically within the `Parsable` impls of domain and log types). After the split, `domain.rs` and `log.rs` will need access to these constructors, so they should become `pub(crate)`. The `QuotedTag` struct is also currently private (`struct QuotedTag(Tag)`) and used only internally.

**Edition 2024 module paths:** The project's `Cargo.toml` specifies `edition = "2024"`. This means:
- `src/parse.rs` becomes `src/parse.rs` (module root) with `src/parse/` directory for sub-modules
- Sub-modules are declared as `src/parse/combinators.rs`, `src/parse/domain.rs`, `src/parse/log.rs`
- NO `mod.rs` files are needed or wanted
- Rust 2024 resolves `src/parse.rs` as the module root and `src/parse/` as the sub-module directory without ambiguity

---

## Goals

1. **Create `src/parse/` directory and sub-module files.** Establish the new module structure: `src/parse/combinators.rs`, `src/parse/domain.rs`, `src/parse/log.rs`. Use edition 2024 module paths (no `mod.rs`).

2. **Move combinator framework to `src/parse/combinators.rs`.** Move the `Parser` and `Parsable` trait definitions, all combinator structs (`Tag`, `Unquote`, `QuotedTag`, `StripWhitespace`, `Delimited`, `Map`, `Preceded`, `Tuple`, `KeyValue`, `Permutation`, `List`, `Alt`, `Take`), their `Parser` trait impls, all constructor functions (`tag`, `unquote`, `quoted_tag`, `strip_whitespace`, `delimited`, `map`, `preceded`, `tuple2`, `key_value`, `permutation2`, `permutation3`, `list`, `alt2`, `alt3`, `alt4`, `alt8`, `take`), and helper functions (`quote`, `unquote_escaped`, `unquote_simple`).

3. **Move `primitives` as a private sub-module within `combinators.rs`.** The `primitives` module (containing `U32`, `I32`, `Byte`) becomes a private sub-module of the `combinators` module. It can remain inline within `combinators.rs` or be extracted to `src/parse/combinators/primitives.rs` -- either approach satisfies the requirement. The `primitives` types must remain accessible to `domain.rs` and `log.rs` via re-exports.

4. **Move domain types to `src/parse/domain.rs`.** Move `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements`, the `AUTHDATA_SIZE` constant, and the `just_parse` function. Each type's `Parsable` impl moves with its struct definition.

5. **Move log hierarchy to `src/parse/log.rs`.** Move `LogLine`, `LogKind`, `SystemLogKind`, `SystemLogTraceKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogTraceKind`, `AppLogJournalKind`. Each enum's `Parsable` impl moves with its definition.

6. **Convert `src/parse.rs` to module root.** The file becomes a thin module root declaring `mod combinators; mod domain; mod log;` and providing `pub use` re-exports so that `src/lib.rs` (which uses `use parse::*;`) continues to see all public types without modification.

7. **Refine visibility: constructor functions to `pub(crate)`.** Constructor functions (currently private `fn`) that are called across sub-module boundaries must become `pub(crate)`. This includes `tag`, `unquote`, `quoted_tag`, `strip_whitespace`, `delimited`, `map`, `preceded`, `tuple2`, `key_value`, `permutation2`, `permutation3`, `list`, `alt2`, `alt3`, `alt4`, `alt8`, `take`. The `quote`, `unquote_escaped`, and `unquote_simple` functions should also become `pub(crate)` if referenced from other sub-modules (currently `unquote_simple` is not referenced outside combinators, but `quote` is only used in tests).

8. **Move tests to `#[cfg(test)] mod tests` in each sub-module.** Split the current monolithic test module into per-sub-module test modules. Combinator tests (primitives, tag, quoted_tag, strip_whitespace, delimited, key_value, list, unquote, quote) go into `combinators.rs`. Domain type tests (asset_dsc, backet, authdata, just_parse_*) go into `domain.rs`. Log hierarchy tests (log_kind, withdraw_cash) go into `log.rs`.

9. **Preserve all existing behavior and public API.** The `pub use` re-exports in the module root must ensure that `src/lib.rs` (`use parse::*;`) continues to compile without changes. Same input must produce same output. No tests are deleted.

---

## User Stories

1. **As a developer navigating the codebase**, I want the parser module split into focused sub-modules (combinators, domain, log) so that I can find and understand code faster without scrolling through 1762 lines.

2. **As a developer working on domain types**, I want `domain.rs` to contain only the domain type definitions and their parser implementations so that I can modify domain parsing logic without wading through combinator infrastructure or log hierarchy code.

3. **As a developer working on the log hierarchy**, I want `log.rs` to contain only the log enum definitions and their parser implementations so that I can modify log parsing without affecting domain types or combinator internals.

4. **As a developer working on parser combinators**, I want `combinators.rs` to contain the full parser combinator framework so that I can add new combinators or modify existing ones in isolation.

5. **As a contributor reading `src/lib.rs`**, I want `use parse::*;` to continue working unchanged after the split so that the library crate's public API is preserved transparently.

6. **As a developer in subsequent phases**, I want the module split in place before starting newtypes (phase 16), error handling (phase 17), and other improvements so that changes touch smaller, focused files.

---

## Scenarios

### Scenario 1: Create module directory and sub-module files

**Before:**
```
src/
  lib.rs
  parse.rs        # 1762 lines, monolithic
  main.rs
```

**After:**
```
src/
  lib.rs           # unchanged
  parse.rs         # module root (~10-20 lines): mod declarations + pub use re-exports
  parse/
    combinators.rs # Parser/Parsable traits, combinator structs, constructors, primitives
    domain.rs      # AuthData, AssetDsc, Backet, UserCash, UserBacket, UserBackets, Announcements
    log.rs         # LogLine, LogKind, SystemLogKind, AppLogKind, and all sub-enums
  main.rs          # unchanged
```

### Scenario 2: Module root with re-exports

**`src/parse.rs` (after):**
```rust
mod combinators;
mod domain;
mod log;

pub use combinators::*;
pub use domain::*;
pub use log::*;
```

This ensures `use parse::*;` in `lib.rs` continues to resolve all public types: `Parser`, `Parsable`, `LogLine`, `LogKind`, `SystemLogKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogJournalKind`, `AssetDsc`, `Backet`, `UserCash`, etc.

### Scenario 3: Cross-module dependency chain

**Dependency graph between sub-modules:**
```
combinators.rs  <--  domain.rs  <--  log.rs
     |                   ^              |
     |                   +--------------+
     |
     +-- primitives (private sub-module)
```

- `combinators.rs`: standalone, no dependencies on domain or log
- `domain.rs`: depends on combinator types (`Map`, `Delimited`, `Tuple`, `Permutation`, `KeyValue`, `List`, `Unquote`, `Tag`, `StripWhitespace`, `Take`) and primitives (`primitives::U32`, `primitives::Byte`) and constructor functions (`map`, `delimited`, `tuple2`, `strip_whitespace`, `tag`, `permutation2`, `key_value`, `unquote`, `list`, `take`)
- `log.rs`: depends on combinators (same as domain) AND domain types (`UserCash`, `UserBacket`, `AuthData`, `Announcements`, `Backet`)

### Scenario 4: Visibility refinement

**Before (in monolithic `parse.rs`):**
```rust
fn tag(tag: &'static str) -> Tag {    // private, but everything is in one module
    Tag { tag }
}
```

**After (in `combinators.rs`):**
```rust
pub(crate) fn tag(tag: &'static str) -> Tag {    // accessible to domain.rs and log.rs
    Tag { tag }
}
```

Constructor functions that need cross-sub-module access: `tag`, `unquote`, `quoted_tag`, `strip_whitespace`, `delimited`, `map`, `preceded`, `tuple2`, `key_value`, `permutation2`, `permutation3`, `list`, `alt2`, `alt3`, `alt4`, `alt8`, `take`.

### Scenario 5: Test distribution

**Before:** Single `#[cfg(test)] mod test { ... }` at end of `parse.rs`.

**After:**
- `combinators.rs`: `#[cfg(test)] mod tests { ... }` with `test_u32`, `test_i32`, `test_quote`, `test_unquote_simple`, `test_unquote`, `test_tag`, `test_quoted_tag`, `test_strip_whitespace`, `test_delimited`, `test_key_value`, `test_list`
- `domain.rs`: `#[cfg(test)] mod tests { ... }` with `test_authdata`, `test_asset_dsc`, `test_backet`, `test_just_parse_asset_dsc`, `test_just_parse_backet`, `test_just_parse_user_cash`, `test_just_parse_user_backet`, `test_just_parse_user_backets`, `test_just_parse_announcements`, `test_just_parse_error_cases`
- `log.rs`: `#[cfg(test)] mod tests { ... }` with `test_log_kind`, `test_withdraw_cash`

---

## Metrics

| Metric | Target |
|---|---|
| `cargo test` | All tests pass (no test cases deleted) |
| `cargo run -- example.log` | Output identical to pre-phase |
| `src/parse.rs` line count | ~10-20 lines (module root only) |
| `src/parse/combinators.rs` | ~800-900 lines (combinators + combinator tests) |
| `src/parse/domain.rs` | ~350-400 lines (domain types + domain tests) |
| `src/parse/log.rs` | ~550-600 lines (log hierarchy + log tests) |
| `src/lib.rs` changes | Zero — `use parse::*;` continues to work unchanged |
| `src/main.rs` changes | Zero |
| Compiler warnings | Zero new warnings |
| Behavior change | None — pure structural refactor |
| `mod.rs` files | Zero — uses edition 2024 module paths |

---

## Constraints

1. **Zero external dependencies.** No new crates in `Cargo.toml`.
2. **No behavior changes.** Same input must produce same output. This is a pure structural refactor.
3. **No test deletions.** Existing tests are not deleted. They are redistributed across sub-module test modules. Test logic and assertions remain identical.
4. **No `mod.rs` files.** Uses edition 2024 module path convention. Sub-modules are `src/parse/combinators.rs`, not `src/parse/combinators/mod.rs`.
5. **Preserve public API.** All types currently accessible via `use parse::*;` in `lib.rs` must remain accessible. The module root must re-export all public items.
6. **`src/lib.rs` must not change.** The `pub mod parse; use parse::*;` declaration and all pattern matches in `read_log()` must compile without modification.
7. **`src/main.rs` must not change.** The binary crate must compile without modification.
8. **Phase 14 prerequisite.** This phase assumes all Phase 14 renames (`Tuple`, `tuple2`, `primitives`, `unquote_escaped`, `unquote_simple`) are complete. Verified: they are in place.
9. **One issue category = one commit.** Per project conventions, this entire phase is a single modularity issue category and can be a single commit.
10. **Existing Russian comments left as-is.** Comments are moved along with the code they annotate. No translation is performed.

---

## Risks

| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Circular dependency between sub-modules. | Very Low | Medium | The dependency graph is strictly layered: `combinators` <- `domain` <- `log`. No cycles. `combinators.rs` has no dependency on `domain.rs` or `log.rs`. |
| Missing `pub use` re-export causes compilation failure in `lib.rs`. | Low | Low | Enumerate all public items referenced in `lib.rs` and ensure each has a `pub use` in the module root. `cargo build` will immediately catch missing re-exports. Items needed: `LogLine`, `Parsable`, `Parser`, `LogKind`, `SystemLogKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogJournalKind`. |
| Visibility change breaks internal access. | Low | Low | Constructor functions currently private (`fn tag(...)`) are only called within `parse.rs`. After the split, they are called across sub-module boundaries. Making them `pub(crate)` resolves this. `cargo build` will catch any remaining visibility errors. |
| `primitives` module visibility issue. | Low | Low | `primitives` is currently `mod primitives { ... }` (private) inside `parse.rs`. After moving into `combinators.rs`, it needs to be `pub(crate) mod primitives` or its types re-exported as `pub(crate)`, so that `domain.rs` and `log.rs` can reference `primitives::U32`, `primitives::I32`, `primitives::Byte`. |
| Test `use super::*;` breaks after move. | Low | Low | Each test module uses `use super::*;` to import items from its parent module. After redistribution, each test module's imports need to cover the items it tests. Tests in `domain.rs` need access to combinator types (via `use super::*;` which gets the domain module's imports). Tests in `log.rs` similarly need domain and combinator types. |
| Edition 2024 `src/parse.rs` + `src/parse/` coexistence. | Very Low | Low | Rust edition 2024 natively supports having both `src/parse.rs` (module root) and `src/parse/` (sub-module directory). This is the standard pattern in edition 2024. No `mod.rs` needed. |
| Merge conflicts if other phases run concurrently. | Low | Low | This phase modifies only `src/parse.rs` (deleting its contents) and creates new files in `src/parse/`. No other phase is expected to run concurrently. |

---

## Open Questions

None. The phase specification is complete. The current codebase structure has been analyzed, dependency relationships between the three code groups are well-understood, and the edition 2024 module path convention is straightforward. Each sub-task is a mechanical code move with visibility adjustments.

---

## Files Affected

| File | Changes |
|---|---|
| `src/parse.rs` | Replace 1762 lines of code with ~10-20 line module root: `mod combinators; mod domain; mod log;` plus `pub use` re-exports for all public types. |
| `src/parse/combinators.rs` | **New file.** Contains `Parser` trait, `Parsable` trait, `mod primitives` (private sub-module with `U32`, `I32`, `Byte`), all combinator structs and their `Parser` impls, all constructor functions (now `pub(crate)`), helper functions (`quote`, `unquote_escaped`, `unquote_simple`), and combinator-related tests. |
| `src/parse/domain.rs` | **New file.** Contains `AUTHDATA_SIZE` constant, `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements` (struct definitions + `Parsable` impls), `just_parse` function, and domain-related tests. Uses `use super::combinators::*;` (or equivalent) to access combinator types and constructors. |
| `src/parse/log.rs` | **New file.** Contains `LogLine`, `LogKind`, `SystemLogKind`, `SystemLogTraceKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogTraceKind`, `AppLogJournalKind` (enum definitions + `Parsable` impls), and log-related tests. Uses `use super::combinators::*;` and `use super::domain::*;` (or equivalent) to access combinators and domain types. |
| `src/lib.rs` | No changes expected. `pub mod parse; use parse::*;` continues to work via re-exports. |
| `src/main.rs` | No changes expected. |
