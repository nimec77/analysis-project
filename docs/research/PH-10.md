# Research: PH-10 — Box the Large Enum Variant

**Ticket:** PH-10
**Date:** 2026-02-17
**PRD:** `docs/prd/PH-10.prd.md`
**Phase spec:** `docs/phase/phase-10.md`

---

## 1. Resolved Questions

The PRD has no open questions. The user confirmed: proceed with documented requirements only; no additional constraints or preferences.

---

## 2. Related Modules and Services

### 2.1 `src/parse.rs` — Primary change target

This is the only file that needs modification. All four change sites are in this file:

| Location | Lines | What |
|---|---|---|
| `AuthData` struct definition | 720-725 | Hint comment `// подсказка: довольно много места на стэке` at line 722, struct at line 725. The struct itself (`pub struct AuthData([u8; AUTHDATA_SIZE])`) is NOT changed. Only the hint comment above it is removed. |
| `AppLogTraceKind` enum definition | 979-987 | Hint comment `// подсказка: а поля не слишком много места на стэке занимают?` at line 979. The `Connect(AuthData)` variant at line 983 changes to `Connect(Box<AuthData>)`. The hint comment is removed. |
| `Parsable` impl for `AppLogTraceKind` | 1147-1206 | The associated `Parser` type at line 1153 uses `fn(AuthData) -> AppLogTraceKind`. The closure at line 1181 (`\|authdata\| AppLogTraceKind::Connect(authdata)`) wraps in `Box::new()`. |
| `test_log_kind` test | 1652 | The expected value `AppLogTraceKind::Connect(AuthData([...]))` changes to `AppLogTraceKind::Connect(Box::new(AuthData([...])))`. |

### 2.2 `src/lib.rs` — No changes needed

The `read_log()` filtering logic uses `matches!()` macros that only check variant shapes, not inner data. `Connect` is never destructured in `lib.rs`. The test data in `lib.rs` contains `App::Trace Connect ...` strings which are parsed at runtime; the string representation does not change, only the in-memory type. No modifications needed.

### 2.3 `src/main.rs` — No changes needed

The CLI binary only calls `read_log()` and prints `LogLine` via `Debug` formatting. The `Debug` output will change slightly (it will show `Connect(AuthData([...]))` instead of `Connect(AuthData([...]))` because `Box` implements `Debug` by delegating to the inner type), so the output remains identical. No modifications needed.

---

## 3. Current Endpoints and Contracts

### 3.1 Public types affected

`AppLogTraceKind` is a `pub` enum exported from `parse.rs` (and re-exported from `lib.rs` via `pub mod parse; use parse::*;`). The variant signature change from `Connect(AuthData)` to `Connect(Box<AuthData>)` is a **breaking API change** for any external code that:
- Constructs the variant: `AppLogTraceKind::Connect(authdata)` must become `AppLogTraceKind::Connect(Box::new(authdata))`
- Pattern-matches the variant: `Connect(authdata)` destructures differently (yields `Box<AuthData>` instead of `AuthData`)

This is acceptable per the PRD constraints: "This is acceptable for this internal refactoring project."

### 3.2 Internal consumers

A search for `AppLogTraceKind::Connect` and `Connect(` across `src/` confirms only three sites in `src/parse.rs`:
1. Line 983: Variant definition
2. Line 1181: Parser closure
3. Line 1652: Test assertion

No other code constructs or destructures this variant.

---

## 4. Patterns Used

### 4.1 Parser combinator associated type pattern

Every `Parsable` impl spells out its `type Parser` using fully-qualified combinator types. The map function argument is always typed as a **function pointer** (`fn(InputType) -> OutputType`), not as a generic closure type. For example:

```rust
// Line 1153 (current)
fn(AuthData) -> AppLogTraceKind
```

The closures in the `parser()` body (e.g., `|authdata| AppLogTraceKind::Connect(authdata)`) are **non-capturing closures** that coerce to the function pointer type `fn(AuthData) -> AppLogTraceKind`.

### 4.2 Key constraint: function pointer coercion

When we change the variant to `Connect(Box<AuthData>)`, the closure `|authdata| AppLogTraceKind::Connect(Box::new(authdata))` still takes `AuthData` as input and returns `AppLogTraceKind`, so it matches the function pointer type `fn(AuthData) -> AppLogTraceKind`. The critical point is:

- The closure `|authdata| AppLogTraceKind::Connect(Box::new(authdata))` captures no environment variables.
- A non-capturing closure can coerce to a function pointer in Rust.
- Therefore, the associated type `fn(AuthData) -> AppLogTraceKind` at line 1153 **does NOT need to change**.

This means the type signature remains `fn(AuthData) -> AppLogTraceKind`, and only the closure body changes. This is the simplest path.

**Alternative approach** (if coercion fails for any reason): Define a named function:
```rust
fn connect_boxed(authdata: AuthData) -> AppLogTraceKind {
    AppLogTraceKind::Connect(Box::new(authdata))
}
```
and pass it as the map function. This guarantees function pointer compatibility.

### 4.3 Hint comment removal pattern

Previous phases have removed `// подсказка:` comments after resolving the technical debt they identify. This is consistent with the project convention documented in `docs/vision.md`: "Focus on locations marked with `// подсказка:`. Fixing every hint is mandatory."

---

## 5. Limitations and Risks

### 5.1 Parser type signature (LOW RISK)

The associated type `fn(AuthData) -> AppLogTraceKind` at line 1153 does NOT change. The input to the map function is still `AuthData` (coming from `AuthData::parser()`), and the output is still `AppLogTraceKind`. Only the closure body changes to wrap the value in `Box::new()`. Since `|authdata| AppLogTraceKind::Connect(Box::new(authdata))` is a non-capturing closure returning `AppLogTraceKind`, it coerces to `fn(AuthData) -> AppLogTraceKind`.

**Mitigation if coercion fails:** Use a named function instead of a closure.

### 5.2 Heap allocation overhead (NEGLIGIBLE RISK)

Each `Connect` log entry will now require one heap allocation for the `Box<AuthData>`. The `AuthData` contains 1024 bytes that are already being parsed from a hex string with per-byte conversion. The single heap allocation is negligible. The benefit of reducing every `LogLine` from ~1040 bytes to ~40 bytes on the stack vastly outweighs this cost.

### 5.3 Debug output (NO RISK)

`Box<T>` implements `Debug` by delegating to `T::fmt()`. The `Debug` output of `Connect(Box::new(AuthData([...])))` is identical to `Connect(AuthData([...]))`. Therefore, `cargo run -- example.log` output is unchanged.

### 5.4 Clone behavior (NO RISK)

`Box<T>` implements `Clone` when `T: Clone`. `AuthData` derives `Clone`. Therefore, `AppLogTraceKind` (which derives `Clone`) continues to compile. Cloning a `Connect` variant will now clone the heap-allocated data, but this matches the existing deep-copy behavior.

### 5.5 PartialEq behavior (NO RISK)

`Box<T>` implements `PartialEq` when `T: PartialEq`. `AuthData` derives `PartialEq`. All test assertions using `assert_eq!` continue to work.

---

## 6. Exact Changes Required

### Change 1: Remove hint comment at line 722

**File:** `src/parse.rs`, line 722
**Before:**
```rust
// подсказка: довольно много места на стэке
/// Данные для авторизации
```
**After:**
```rust
/// Данные для авторизации
```

### Change 2: Remove hint comment at line 979 and change variant

**File:** `src/parse.rs`, lines 979 and 983
**Before:**
```rust
// подсказка: а поля не слишком много места на стэке занимают?
/// Trace [приложения](AppLogKind)
#[derive(Debug, Clone, PartialEq)]
pub enum AppLogTraceKind {
    Connect(AuthData),
```
**After:**
```rust
/// Trace [приложения](AppLogKind)
#[derive(Debug, Clone, PartialEq)]
pub enum AppLogTraceKind {
    Connect(Box<AuthData>),
```

### Change 3: Update parser closure at line 1181

**File:** `src/parse.rs`, line 1181
**Before:**
```rust
|authdata| AppLogTraceKind::Connect(authdata),
```
**After:**
```rust
|authdata| AppLogTraceKind::Connect(Box::new(authdata)),
```

Note: The associated type at line 1153 (`fn(AuthData) -> AppLogTraceKind`) does NOT change -- the closure still accepts `AuthData` and returns `AppLogTraceKind`.

### Change 4: Update test assertion at line 1652

**File:** `src/parse.rs`, line 1652
**Before:**
```rust
...AppLogTraceKind::Connect(AuthData([0x30,0xc3,...]))...
```
**After:**
```rust
...AppLogTraceKind::Connect(Box::new(AuthData([0x30,0xc3,...])))...
```

---

## 7. Size Impact (Expected)

| Type | Before (approx.) | After (approx.) |
|---|---|---|
| `AuthData` | 1024 bytes | 1024 bytes (unchanged) |
| `AppLogTraceKind` | ~1032 bytes | ~32 bytes |
| `AppLogKind` | ~1032 bytes | ~32 bytes |
| `LogKind` | ~1032 bytes | ~32 bytes |
| `LogLine` | ~1040 bytes | ~40 bytes |

---

## 8. Verification

```bash
cargo test                    # All tests must pass
cargo run -- example.log      # Output must be identical to pre-change
```

Optional size verification (can be added as a temporary test or assertion):
```rust
assert!(std::mem::size_of::<AppLogTraceKind>() < 64);
assert!(std::mem::size_of::<LogLine>() < 64);
```

---

## 9. New Technical Questions

None discovered. The change is well-scoped and all affected locations have been identified. The only subtle point -- whether the closure coerces to the function pointer type -- is well-understood in Rust (non-capturing closures coerce to `fn` pointers).

---

## 10. Deviations from Requirements

**No deviations found.** The current codebase matches the PRD's description exactly:
- `AuthData` is at line 725 with the hint at line 722
- `AppLogTraceKind::Connect(AuthData)` is at line 983 with the hint at line 979
- The `Parsable` impl uses `fn(AuthData) -> AppLogTraceKind` at line 1153
- The test assertion is at line 1652
- No other code references `Connect` variant
