# Research: PH-13 — Bug fix + dead code cleanup

**Ticket:** PH-13
**Date:** 2026-02-17
**PRD:** `docs/prd/PH-13.prd.md`
**Phase spec:** `docs/phase/phase-13.md`

---

## 1. Resolved Questions

The PRD has no open questions. The user confirmed: proceed with documented requirements only; no additional constraints or preferences.

---

## 2. Related Modules and Services

### 2.1 `src/parse.rs` — Sole modification target

This is the only file modified in this phase. It contains the bug to fix, all dead code to remove, and the test module where the regression test is added.

### 2.2 `src/lib.rs` — No changes needed

`lib.rs` references `AppLogJournalKind::WithdrawCash(_)` in the `ReadMode::Exchanges` filter (line 88) and in the `test_exchanges_mode` test (line 238). These already match on `WithdrawCash` correctly. The bug is only in how the parser *produces* the variant, not in how the filter *matches* it. No changes to `lib.rs` are needed.

### 2.3 `src/main.rs` — No changes needed

`main.rs` calls `analysis::read_log()` and prints results via `Debug`. No direct reference to any affected types.

### 2.4 `example.log` — No `WithdrawCash` entries

Confirmed: `example.log` contains zero `WithdrawCash` log lines. The bug fix does not change the output of `cargo run -- example.log`.

---

## 3. Bug Analysis: `WithdrawCash` Mapping Error

### 3.1 Location

**File:** `src/parse.rs`, lines 1318-1321
**Context:** Inside the `Parsable` impl for `AppLogJournalKind`, within an `alt8(...)` combinator call.

### 3.2 Current code (buggy)

```rust
// Line 1314-1316: DepositCash arm (CORRECT)
map(
    preceded(strip_whitespace(tag("DepositCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::DepositCash(user_cash),
),
// Line 1318-1321: WithdrawCash arm (BUG)
map(
    preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
    |user_cash| AppLogJournalKind::DepositCash(user_cash),  // <-- BUG: should be WithdrawCash
),
```

### 3.3 Root cause

Copy-paste error. The `WithdrawCash` arm was copied from the `DepositCash` arm directly above it. The `tag("WithdrawCash")` was updated, but the mapping closure was not changed from `AppLogJournalKind::DepositCash(user_cash)` to `AppLogJournalKind::WithdrawCash(user_cash)`.

### 3.4 Impact

Any log line containing `App::Journal WithdrawCash ...` is parsed and silently misclassified as `AppLogJournalKind::DepositCash(...)`. This means:
- `ReadMode::Exchanges` filter still includes the entry (it matches `DepositCash(_)`)
- But the entry is indistinguishable from an actual `DepositCash` entry in the output
- The `AppLogJournalKind::WithdrawCash(_)` variant is never constructed by the parser

### 3.5 Fix

Single-token change at line 1320:

```rust
// Before:
    |user_cash| AppLogJournalKind::DepositCash(user_cash),
// After:
    |user_cash| AppLogJournalKind::WithdrawCash(user_cash),
```

### 3.6 Enum variant confirmation

The `AppLogJournalKind` enum (lines 984-1005) has both variants defined:

```rust
pub enum AppLogJournalKind {
    // ...
    DepositCash(UserCash),
    WithdrawCash(UserCash),
    // ...
}
```

Both variants take `UserCash`. The fix is type-safe -- only the variant name changes.

---

## 4. Regression Test Design

### 4.1 Test pattern

Existing tests in `parse::test` follow this pattern:
- Parse a string using `LogKind::parser().parse(...)` or `LogLine::parser().parse(...)`
- Assert the result matches a specific variant with expected field values
- The `DepositCash` test at line 1670 provides the closest template

### 4.2 Existing `DepositCash` test (line 1668-1680)

```rust
assert_eq!(
    LogKind::parser()
        .parse(r#"App::Journal DepositCash UserCash{"user_id": "Steeve", "count": 10,}"#),
    Ok((
        "",
        LogKind::App(AppLogKind::Journal(AppLogJournalKind::DepositCash(
            UserCash {
                user_id: "Steeve".into(),
                count: nz(10)
            }
        )))
    ))
);
```

### 4.3 Proposed `WithdrawCash` test

Following the exact same pattern, the new test should:
1. Parse a line with `App::Journal WithdrawCash UserCash{...}`
2. Assert the result is `AppLogJournalKind::WithdrawCash(...)` (not `DepositCash`)
3. Verify the `UserCash` payload is correctly extracted

```rust
#[test]
fn test_withdraw_cash() {
    assert_eq!(
        LogKind::parser()
            .parse(r#"App::Journal WithdrawCash UserCash{"user_id":"Alice","count":500,}"#),
        Ok((
            "",
            LogKind::App(AppLogKind::Journal(AppLogJournalKind::WithdrawCash(
                UserCash {
                    user_id: "Alice".into(),
                    count: nz(500)
                }
            )))
        ))
    );
}
```

**Important note on PRD test scenario:** The PRD scenario 2 uses the string `"cash":500` as the field name, but the actual `UserCash` parser expects `"count"` as the key (confirmed at `src/parse.rs` line 844: `key_value("count", stdp::U32)`). The test must use `"count"`, not `"cash"`.

### 4.4 Test placement

The new test should be added inside `mod test` in `src/parse.rs` (begins at line 1398). The most logical placement is after the existing `test_log_kind` test (which ends at line 1682) since `test_log_kind` contains the `DepositCash` assertion.

---

## 5. Dead Code Items — Verification and Removal Plan

### 5.1 `AsIs` struct + `Parser` impl (lines 136-144)

**Definition:**
```rust
/// Парсер, возвращающий результат как есть
#[derive(Debug, Clone)]
struct AsIs;
impl Parser for AsIs {
    type Dest = String;
    fn parse<'a>(&self, input: &'a str) -> Result<(&'a str, Self::Dest), ()> {
        Ok((&input[input.len()..], input.to_string()))
    }
}
```

**References found:** Only at definition (lines 138-143). Zero call sites, zero test references, zero type references.
**Compiler warning:** `warning: struct 'AsIs' is never constructed` at line 138.
**Action:** Delete lines 136-144 (doc comment, derive, struct, impl block).

### 5.2 `Either<Left, Right>` enum (lines 730-734)

**Definition:**
```rust
/// Конструкция 'либо-либо'
enum Either<Left, Right> {
    Left(Left),
    Right(Right),
}
```

**References found:** Only at definition (line 731). Zero usages anywhere.
**Compiler warning:** `warning: enum 'Either' is never used` at line 731.
**Action:** Delete lines 730-734 (doc comment, enum definition).

### 5.3 `Status` enum + `Parsable` impl (lines 736-758)

**Definition:**
```rust
/// Статус, которые можно парсить
enum Status {
    Ok,
    Err(String),
}
impl Parsable for Status {
    type Parser = Alt<(
        Map<Tag, fn(()) -> Self>,
        Map<Delimited<Tag, Unquote, Tag>, fn(String) -> Self>,
    )>;
    fn parser() -> Self::Parser {
        fn to_ok(_: ()) -> Status {
            Status::Ok
        }
        fn to_err(error: String) -> Status {
            Status::Err(error)
        }
        alt2(
            map(tag("Ok"), to_ok),
            map(delimited(tag("Err("), unquote(), tag(")")), to_err),
        )
    }
}
```

**References found:** Only at definition (lines 737-758) and self-references within the `Parsable` impl. Zero external usages.
**Compiler warning:** `warning: enum 'Status' is never used` at line 737.
**Action:** Delete lines 736-758 (doc comment, enum definition, Parsable impl).

### 5.4 `all3()` constructor (lines 329-335)

**Definition:**
```rust
/// Конструктор [All] для трёх парсеров
/// (в Rust нет чего-то, вроде variadic templates из C++)
fn all3<A0: Parser, A1: Parser, A2: Parser>(a0: A0, a1: A1, a2: A2) -> All<(A0, A1, A2)> {
    All {
        parser: (a0, a1, a2),
    }
}
```

**References found:** Only at definition (line 331). Zero call sites. (`all2` is used extensively; `all3` is not.)
**Compiler warning:** `warning: function 'all3' is never used` at line 331.
**Retention of `All<(A0, A1, A2)>` `Parser` impl:** The `impl Parser for All<(A0, A1, A2)>` block (lines 314-328) is retained. It is the generic implementation that makes 3-tuple `All` work. Only the convenience constructor is removed.
**Action:** Delete lines 329-335 (doc comments, function definition).

### 5.5 `all4()` constructor (lines 354-365)

**Definition:**
```rust
/// Конструктор [All] для четырёх парсеров
/// (в Rust нет чего-то, вроде variadic templates из C++)
fn all4<A0: Parser, A1: Parser, A2: Parser, A3: Parser>(
    a0: A0,
    a1: A1,
    a2: A2,
    a3: A3,
) -> All<(A0, A1, A2, A3)> {
    All {
        parser: (a0, a1, a2, a3),
    }
}
```

**References found:** Only at definition (line 356). Zero call sites.
**Compiler warning:** `warning: function 'all4' is never used` at line 356.
**Retention of `All<(A0, A1, A2, A3)>` `Parser` impl:** The `impl Parser for All<(A0, A1, A2, A3)>` block (lines 336-353) is retained. Only the convenience constructor is removed.
**Action:** Delete lines 354-365 (doc comments, function definition).

---

## 6. Current Compiler Warnings

Running `cargo build` produces 7 warnings. Of those, 5 are addressed by this phase:

| Warning | Line | Addressed by PH-13? |
|---|---|---|
| `struct AsIs is never constructed` | 138 | Yes (task 13.3) |
| `function all3 is never used` | 331 | Yes (task 13.6) |
| `function all4 is never used` | 356 | Yes (task 13.7) |
| `enum Either is never used` | 731 | Yes (task 13.4) |
| `enum Status is never used` | 737 | Yes (task 13.5) |
| `function quote is never used` | 77 | No (out of scope) |
| `struct I32 is never constructed` | 44 | No (out of scope) |

After this phase, the `quote` and `I32` warnings will remain. These are not in scope per the PRD.

---

## 7. Deletion Order and Line Shift Considerations

Dead code items should be deleted in reverse line-number order (bottom-up) to avoid line-number shifts affecting subsequent deletions:

1. **Status enum + Parsable impl** (lines 736-758) -- 23 lines deleted
2. **Either enum** (lines 730-734) -- 5 lines deleted (plus blank line at 735)
3. **all4() constructor** (lines 354-365) -- 12 lines deleted
4. **all3() constructor** (lines 329-335) -- 7 lines deleted
5. **AsIs struct + Parser impl** (lines 136-144) -- 9 lines deleted

The bug fix at line 1320 and the test addition at the end of the file are independent of the deletions and can be done in any order.

---

## 8. Patterns Used

### 8.1 Alt combinator pattern

The `WithdrawCash` arm is one of 8 alternatives inside an `alt8(...)` call in the `AppLogJournalKind::parser()` method. Each arm uses `map(preceded(strip_whitespace(tag("VariantName")), Payload::parser()), |payload| AppLogJournalKind::Variant(payload))`. The fix maintains this exact pattern.

### 8.2 Test pattern for journal kinds

The existing `test_log_kind` test function (lines 1626-1682) contains assertions for several journal types: `CreateUser`, `DeleteUser`, `RegisterAsset`, `DepositCash`, `BuyAsset`. No `WithdrawCash` or `SellAsset` assertions exist. The new test adds `WithdrawCash` coverage.

### 8.3 Helper `nz()` function in tests

The test module defines `fn nz(n: u32) -> NonZeroU32` at line 1402. The `WithdrawCash` test will use `nz(500)` for the `count` field, following the same convention.

---

## 9. Limitations and Risks

### 9.1 PRD test scenario field name discrepancy (LOW RISK)

The PRD scenario 2 shows the test input as:
```
App::Journal WithdrawCash UserCash{"user_id":"Alice","cash":500,} requestid=11
```

The actual `UserCash` parser uses `"count"` as the key name (line 844), not `"cash"`. The test must use `"count"`. The PRD scenario is illustrative; the actual field name in the implementation is authoritative for test construction.

### 9.2 `All` tuple impl retention after constructor removal (NO RISK)

Removing `all3()` and `all4()` deletes only the convenience constructor functions. The generic `impl Parser for All<(A0, A1, A2)>` and `impl Parser for All<(A0, A1, A2, A3)>` blocks remain in place. These impls are needed if anyone constructs `All { parser: (a, b, c) }` directly, and they are part of the parser combinator framework's completeness. The PRD explicitly states these impls should be retained.

### 9.3 No existing test covers `WithdrawCash` parsing (CONFIRMED)

A search of the entire test module confirms zero assertions on `WithdrawCash`. The bug has been silent because there is no `WithdrawCash` entry in the test data or `example.log`. The new regression test will close this gap.

### 9.4 `quote` and `I32` warnings persist (EXPECTED)

After this phase, 2 dead-code warnings will remain (`quote` at line 77, `I32` at line 44). These are not in scope for PH-13 and may be addressed in a future phase.

---

## 10. Exact Changes Required

### Change 1: Fix `WithdrawCash` mapping (line 1320)

**File:** `src/parse.rs`, line 1320
**Before:**
```rust
                    |user_cash| AppLogJournalKind::DepositCash(user_cash),
```
**After:**
```rust
                    |user_cash| AppLogJournalKind::WithdrawCash(user_cash),
```

### Change 2: Add `WithdrawCash` regression test

**File:** `src/parse.rs`, inside `mod test` block, after `test_log_kind` (after line 1682)
**Add:**
```rust
    #[test]
    fn test_withdraw_cash() {
        assert_eq!(
            LogKind::parser()
                .parse(r#"App::Journal WithdrawCash UserCash{"user_id":"Alice","count":500,}"#),
            Ok((
                "",
                LogKind::App(AppLogKind::Journal(AppLogJournalKind::WithdrawCash(
                    UserCash {
                        user_id: "Alice".into(),
                        count: nz(500)
                    }
                )))
            ))
        );
    }
```

### Change 3: Delete `AsIs` struct + Parser impl (lines 136-144)

Delete 9 lines: doc comment, `#[derive]`, struct definition, `impl Parser for AsIs` block.

### Change 4: Delete `Either<Left, Right>` enum (lines 730-734)

Delete 5 lines: doc comment, enum definition with variants.

### Change 5: Delete `Status` enum + Parsable impl (lines 736-758)

Delete 23 lines: doc comment, enum definition, `impl Parsable for Status` block with helper functions.

### Change 6: Delete `all3()` constructor (lines 329-335)

Delete 7 lines: doc comments, function definition.

### Change 7: Delete `all4()` constructor (lines 354-365)

Delete 12 lines: doc comments, function definition.

---

## 11. Verification

```bash
cargo test                    # All tests pass (25 existing + 1 new = 26)
cargo run -- example.log      # Output identical to pre-phase
```

Additional verification:
- Zero occurrences of `AsIs` in `src/parse.rs`
- Zero occurrences of `Either` in `src/parse.rs`
- Zero occurrences of `enum Status` in `src/parse.rs`
- Zero occurrences of `fn all3` in `src/parse.rs`
- Zero occurrences of `fn all4` in `src/parse.rs`
- `WithdrawCash` mapping closure produces `AppLogJournalKind::WithdrawCash` (not `DepositCash`)
- New `test_withdraw_cash` test present and passing
- Dead-code warnings reduced from 7 to 2 (only `quote` and `I32` remain)
- No external dependencies added to `Cargo.toml`
- Only `src/parse.rs` is modified

---

## 12. Commit Strategy

Per project conventions ("one issue category = one commit"), the phase can be split into two commits:

1. **Bug fix commit:** Fix `WithdrawCash` mapping + add regression test (tasks 13.1, 13.2)
2. **Dead code cleanup commit:** Remove `AsIs`, `Either`, `Status`, `all3`, `all4` (tasks 13.3-13.7)

Alternatively, if the project treats PH-13 as a single issue category, all changes can be in one commit.

---

## 13. Deviations from Requirements

**No deviations found.** The current codebase matches the PRD's description exactly:

- The `WithdrawCash` bug is at line 1320, mapping to `DepositCash` instead of `WithdrawCash` (confirmed)
- `AsIs` struct is at line 138, unused (confirmed by grep and compiler)
- `Either` enum is at line 731, unused (confirmed by grep and compiler)
- `Status` enum is at line 737, unused (confirmed by grep and compiler)
- `all3()` function is at line 331, unused (confirmed by grep and compiler)
- `all4()` function is at line 356, unused (confirmed by grep and compiler)
- The `AppLogJournalKind::WithdrawCash` variant exists in the enum (line 1002)
- No `WithdrawCash` entries in `example.log` (confirmed)
- All 25 existing tests pass (confirmed via `cargo test`)
- Only `src/parse.rs` needs modification (confirmed)

**Minor PRD inaccuracy (non-blocking):** PRD scenario 2 uses `"cash":500` as a field in the test input. The actual `UserCash` parser uses `"count"` as the key name. The implementation test will use the correct field name `"count"`.
