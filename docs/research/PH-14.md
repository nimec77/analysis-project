# Research: PH-14 — Naming improvements

**Ticket:** PH-14
**Date:** 2026-02-18
**PRD:** `docs/prd/PH-14.prd.md`
**Phase spec:** `docs/phase/phase-14.md`

---

## 1. Resolved Questions

The PRD has no open questions. The user confirmed: proceed with documented requirements only; no additional constraints or preferences.

---

## 2. Related Modules and Services

### 2.1 `src/parse.rs` — Sole modification target

This is the only file modified in this phase. All five items to be renamed (`All`, `all2`, `stdp`, `do_unquote`, `do_unquote_non_escaped`) are defined and used exclusively within this file. All doc comments referencing old names are also in this file.

### 2.2 `src/lib.rs` — No changes needed

`lib.rs` contains `ReadMode::All` (an enum variant) and references to `ReadMode::All` in the filter logic and tests. This is a completely different `All` from the parser `All<T>` struct. Grep confirms zero references to the parser `All` struct, `all2`, `stdp`, `do_unquote`, or `do_unquote_non_escaped` in `lib.rs`. The `use parse::*;` import at line 2 would bring in renamed types transparently.

### 2.3 `src/main.rs` — No changes needed

`main.rs` references `analysis::ReadMode::All` (line 68) -- the enum variant, not the parser struct. No references to any of the five items being renamed.

---

## 3. Rename Analysis: `All` to `Tuple`

### 3.1 Current definition (line 282)

```rust
/// Комбинатор, который требует, чтобы все дочерние парсеры отработали,
/// (аналог `all` из `nom`)
#[derive(Debug, Clone)]
pub struct All<T> {
    parser: T,
}
```

### 3.2 All 14 occurrences of `All` in `src/parse.rs`

| Line | Context | Type |
|---|---|---|
| 280 | `/// (аналог \`all\` из \`nom\`)` | Doc comment (update `all` to `tuple`) |
| 282 | `pub struct All<T>` | Struct definition |
| 285 | `impl<A0, A1> Parser for All<(A0, A1)>` | Trait impl (2-tuple) |
| 299 | `/// Конструктор [All] для двух парсеров` | Doc comment intra-doc link |
| 301 | `fn all2<...>(...) -> All<(A0, A1)>` | Return type |
| 302 | `All { parser: (a0, a1) }` | Constructor expression |
| 304 | `impl<A0, A1, A2> Parser for All<(A0, A1, A2)>` | Trait impl (3-tuple) |
| 320 | `impl<A0, A1, A2, A3> Parser for All<(A0, A1, A2, A3)>` | Trait impl (4-tuple) |
| 344 | `All<(StripWhitespace<QuotedTag>, StripWhitespace<Tag>)>` | Type annotation in `KeyValue` |
| 712 | `All<(StripWhitespace<Tag>, StripWhitespace<Tag>)>` | Type annotation in `AssetDsc::parser()` return type |
| 742 | `All<(StripWhitespace<Tag>, StripWhitespace<Tag>)>` | Type annotation in `Backet::parser()` return type |
| 771 | `All<(StripWhitespace<Tag>, StripWhitespace<Tag>)>` | Type annotation in `UserCash::parser()` return type |
| 803 | `All<(StripWhitespace<Tag>, StripWhitespace<Tag>)>` | Type annotation in `UserBacket::parser()` return type |
| 835 | `All<(StripWhitespace<Tag>, StripWhitespace<Tag>)>` | Type annotation in `UserBackets::parser()` return type |
| 1322 | `All<(` | Type annotation in `LogLine::parser()` return type |

**Total:** 14 occurrences (matches PRD exactly).

### 3.3 No name collision

Grep confirms zero existing occurrences of `Tuple` in the codebase. `Tuple` is not a Rust keyword and does not collide with any standard library type.

---

## 4. Rename Analysis: `all2()` to `tuple2()`

### 4.1 Current definition (line 301)

```rust
/// Конструктор [All] для двух парсеров
/// (в Rust нет чего-то, вроде variadic templates из C++)
fn all2<A0: Parser, A1: Parser>(a0: A0, a1: A1) -> All<(A0, A1)> {
    All { parser: (a0, a1) }
}
```

### 4.2 All 9 occurrences of `all2` in `src/parse.rs`

| Line | Context | Type |
|---|---|---|
| 301 | `fn all2<A0: Parser, A1: Parser>` | Function definition |
| 362 | `all2(` in `key_value()` constructor | Call site |
| 722 | `all2(` in `AssetDsc::parser()` | Call site |
| 751 | `all2(strip_whitespace(tag("Backet"))...` in `Backet::parser()` | Call site |
| 780 | `all2(` in `UserCash::parser()` | Call site |
| 812 | `all2(` in `UserBacket::parser()` | Call site |
| 847 | `all2(` in `UserBackets::parser()` | Call site |
| 1330 | `all2(` in `LogLine::parser()` | Call site |
| 1491 | `all2(` in `test_asset_dsc` test | Call site (test) |

**Total:** 9 occurrences (1 definition + 8 call sites). Matches PRD exactly.

### 4.3 No name collision

Grep confirms zero existing occurrences of `tuple2` in the codebase.

---

## 5. Rename Analysis: `stdp` module to `primitives`

### 5.1 Current definition (line 14)

```rust
mod stdp {
    // parsers for std types
    use super::Parser;
    use std::num::NonZeroU32;
    // ... U32, I32, Byte parsers ...
}
```

### 5.2 All 39 occurrences of `stdp` in `src/parse.rs`

| Count | Usage Pattern | Location |
|---|---|---|
| 1 | `mod stdp {` | Module declaration (line 14) |
| 2 | `stdp::Byte` | `AuthData` parser type + body (lines 694, 696) |
| 6 | `stdp::U32` | Production code type annotations (lines 743, 772, 1151, 1164, 1324) and body (line 754, 786, 1206, 1231, 1332) |
| 30 | `stdp::U32`, `stdp::I32` | Test code (lines 1351, 1355, 1358, 1359, 1361, 1365, 1368, 1373, 1374, 1375, 1376, 1377, 1378, 1427, 1435, 1439, 1443, 1447, 1455, 1458, 1459, 1461, 1469, 1473, 1476, 1477) |

**Total:** 39 occurrences (matches PRD exactly).

### 5.3 Breakdown by qualified name

- `stdp::U32`: 32 occurrences (type annotations + constructor usages + test code)
- `stdp::I32`: 6 occurrences (all in test code)
- `stdp::Byte`: 2 occurrences (in `AuthData` parser)

### 5.4 No name collision

Grep confirms zero existing occurrences of `primitives` in the codebase.

---

## 6. Rename Analysis: `do_unquote()` to `unquote_escaped()`

### 6.1 Current definition (line 93)

```rust
/// Распарсить строку, которую ранее [обернули в кавычки](quote)
// `"abc\"def\\ghi"nice` -> (`abcd"def\ghi`, `nice`)
fn do_unquote(input: &str) -> Result<(&str, String), ()> {
    // ... escape-handling logic ...
}
```

### 6.2 All 3 occurrences of `do_unquote` (excluding `do_unquote_non_escaped`) in `src/parse.rs`

| Line | Context | Type |
|---|---|---|
| 93 | `fn do_unquote(input: &str)` | Function definition |
| 114 | `/// (сокращённая версия [do_unquote], ...)` | Doc comment intra-doc link (in `do_unquote_non_escaped` doc) |
| 129 | `do_unquote(input)` | Call site (in `Unquote` parser impl) |

**Total:** 3 occurrences.

**Note:** The PRD states "5 occurrences" but the grep with word-boundary matching finds exactly 3 distinct occurrences of `do_unquote` that are not part of `do_unquote_non_escaped`. The PRD may have counted differently (possibly including the doc comment at line 91 and the code comment at line 92 as separate items, but neither of those lines contains the identifier `do_unquote`).

### 6.3 Doc comment update

Line 91's doc comment (`/// Распарсить строку, которую ранее [обернули в кавычки](quote)`) does not contain `do_unquote`. No change needed on line 91 itself. The function name on line 93 changes.

### 6.4 No name collision

Grep confirms zero existing occurrences of `unquote_escaped` in the codebase.

---

## 7. Rename Analysis: `do_unquote_non_escaped()` to `unquote_simple()`

### 7.1 Current definition (line 115)

```rust
/// Распарсить строку, обёрную в кавычки
/// (сокращённая версия [do_unquote], в которой вложенные кавычки не предусмотрены)
fn do_unquote_non_escaped(input: &str) -> Result<(&str, &str), ()> {
    // ... simple unquoting without escape handling ...
}
```

### 7.2 All 5 occurrences of `do_unquote_non_escaped` in `src/parse.rs`

| Line | Context | Type |
|---|---|---|
| 115 | `fn do_unquote_non_escaped(input: &str)` | Function definition |
| 158 | `let (remaining, candidate) = do_unquote_non_escaped(input)?;` | Call site (in `QuotedTag` parser impl) |
| 1389 | `assert_eq!(do_unquote_non_escaped(r#""411""#), ...)` | Test assertion |
| 1390 | `assert_eq!(do_unquote_non_escaped(r#" "411""#), ...)` | Test assertion |
| 1391 | `assert_eq!(do_unquote_non_escaped(r#"411"#), ...)` | Test assertion |

**Total:** 5 occurrences (matches PRD exactly).

### 7.3 Doc comment cross-reference update

Line 114 contains the intra-doc link `[do_unquote]`. After the `do_unquote` rename (section 6), this must be updated to `[unquote_escaped]`.

### 7.4 Test function name update

The test function at line 1388 is named `test_do_unquote_non_escaped`. This should be renamed to `test_unquote_simple` (or similar) to match the renamed function.

### 7.5 No name collision

Grep confirms zero existing occurrences of `unquote_simple` in the codebase.

---

## 8. Doc Comments Requiring Updates

### 8.1 Complete list of doc comment changes

| Line | Current Text | Required Change |
|---|---|---|
| 114 | `/// (сокращённая версия [do_unquote], в которой ...)` | Change `[do_unquote]` to `[unquote_escaped]` |
| 280 | `/// (аналог \`all\` из \`nom\`)` | Change `` `all` `` to `` `tuple` `` |
| 299 | `/// Конструктор [All] для двух парсеров` | Change `[All]` to `[Tuple]` |

### 8.2 Existing Russian text

Per conventions, existing Russian comments are left as-is. Only the identifier names within comments are updated.

---

## 9. Patterns Used

### 9.1 Rename via find-and-replace

All five renames are mechanical find-and-replace operations within a single file. The Rust compiler will catch any missed references -- a partial rename will produce compilation errors for unresolved identifiers or mismatched types.

### 9.2 Arity-suffix naming convention

The project uses an arity-suffix pattern for combinator constructors: `alt2`, `alt3`, `alt4`, `alt8`, `permutation2`, `permutation3`. Renaming `all2` to `tuple2` follows this same convention. The `All` 3-tuple and 4-tuple `Parser` impls remain (they are generic impls, not constructors), but no corresponding `tuple3`/`tuple4` constructors need to be created -- they did not exist before (the `all3` and `all4` constructors were already removed in PH-13).

### 9.3 Zero-sized stateless structs

All parser combinator structs (`All`/`Tuple`, `Alt`, `Permutation`, etc.) are generic wrappers around their sub-parsers. The rename does not affect the zero-sized nature of these types.

---

## 10. Current Codebase State

### 10.1 Build and test status

- `cargo test`: 26 tests pass, 0 failures
- `cargo build` warnings: 2 (both out of scope for PH-14)
  - `quote` function at line 77 -- never used
  - `I32` struct at line 44 -- never constructed
- Branch: `feature/agent-work`
- Working tree: clean

### 10.2 Post-PH-13 state

PH-13 already removed the following dead code from `src/parse.rs`:
- `AsIs` struct
- `Either` enum
- `Status` enum
- `all3()` constructor
- `all4()` constructor

This means the `All` struct no longer has `all3` or `all4` constructors. Only `all2` remains as a constructor. After PH-14 renames, only `tuple2` will exist. The 3-tuple and 4-tuple `Parser` impls for `Tuple<(A0, A1, A2)>` and `Tuple<(A0, A1, A2, A3)>` remain in place (they are generic impls needed if anyone constructs `Tuple { parser: (a, b, c) }` directly).

---

## 11. Exact Changes Required

All changes are in `src/parse.rs`.

### Change 1: Rename `All` to `Tuple` (14 occurrences)

Replace all 14 occurrences of the word `All` (as a type name) with `Tuple`. This includes:
- Struct definition (line 282)
- Three `Parser` trait impls for 2-tuple, 3-tuple, 4-tuple (lines 285, 304, 320)
- Constructor function return type and body (lines 301, 302)
- Doc comment link (line 299)
- Six type annotations in `Parsable` impl return types (lines 344, 712, 742, 771, 803, 835, 1322)

### Change 2: Rename `all2()` to `tuple2()` (9 occurrences)

Replace all 9 occurrences of the identifier `all2`:
- Function definition (line 301)
- 8 call sites (lines 362, 722, 751, 780, 812, 847, 1330, 1491)

### Change 3: Rename `stdp` to `primitives` (39 occurrences)

Replace all 39 occurrences of the module name `stdp`:
- Module declaration (line 14)
- 38 qualified references (`stdp::U32`, `stdp::I32`, `stdp::Byte`)

### Change 4: Rename `do_unquote()` to `unquote_escaped()` (3 occurrences)

Replace all 3 occurrences:
- Function definition (line 93)
- Intra-doc link in `do_unquote_non_escaped` doc comment (line 114)
- Call site in `Unquote` parser impl (line 129)

### Change 5: Rename `do_unquote_non_escaped()` to `unquote_simple()` (5 occurrences)

Replace all 5 occurrences:
- Function definition (line 115)
- Call site in `QuotedTag` parser impl (line 158)
- 3 test assertions (lines 1389, 1390, 1391)

### Change 6: Update doc comment text (3 lines)

- Line 114: `[do_unquote]` to `[unquote_escaped]`
- Line 280: `` `all` `` to `` `tuple` ``
- Line 299: `[All]` to `[Tuple]`

### Change 7: Rename test function (line 1388)

- `fn test_do_unquote_non_escaped()` to `fn test_unquote_simple()`

---

## 12. Recommended Implementation Order

Since all renames are independent (no rename depends on another being completed first), the order does not matter for correctness. However, a logical grouping:

1. Rename `do_unquote` to `unquote_escaped` (3 changes)
2. Rename `do_unquote_non_escaped` to `unquote_simple` (5 changes + test function name)
3. Rename `All` to `Tuple` (14 changes)
4. Rename `all2` to `tuple2` (9 changes)
5. Rename `stdp` to `primitives` (39 changes)
6. Update doc comments (3 lines)

After all renames, run `cargo test` and `cargo run -- example.log` to verify.

---

## 13. Verification Checklist

```bash
cargo test                    # All 26 tests pass
cargo run -- example.log      # Output identical to pre-phase
```

Additional verification:
- Zero occurrences of `struct All` in `src/parse.rs` (replaced by `struct Tuple`)
- Zero occurrences of `fn all2` in `src/parse.rs` (replaced by `fn tuple2`)
- Zero occurrences of `mod stdp` in `src/parse.rs` (replaced by `mod primitives`)
- Zero occurrences of `fn do_unquote` in `src/parse.rs` (replaced by `fn unquote_escaped`)
- Zero occurrences of `fn do_unquote_non_escaped` in `src/parse.rs` (replaced by `fn unquote_simple`)
- Zero new compiler warnings introduced
- No external dependencies added to `Cargo.toml`
- Only `src/parse.rs` is modified
- All existing tests continue to pass (names updated but logic unchanged)

---

## 14. Limitations and Risks

### 14.1 No conflicts with ReadMode::All (NO RISK)

`ReadMode::All` in `lib.rs` and `main.rs` is an entirely different `All` -- it is an enum variant of `ReadMode`, not the parser `All<T>` struct. Renaming the parser `All<T>` to `Tuple<T>` has no effect on `ReadMode::All`.

### 14.2 Pub visibility of `All` struct (LOW RISK)

The `All` struct is declared `pub` (line 282). However, grep confirms it is only used within `src/parse.rs`. The `pub` visibility is inherited from the parser combinator framework pattern (all combinator structs are `pub`). Renaming to `Tuple` maintains `pub` visibility. No external code references this struct.

### 14.3 Large number of `stdp` replacements (LOW RISK)

39 occurrences is the largest rename. Each is a simple `stdp::` to `primitives::` prefix replacement. The compiler will immediately catch any missed occurrence because `stdp::U32` etc. would not resolve.

### 14.4 Test function rename (VERY LOW RISK)

Renaming `test_do_unquote_non_escaped` to `test_unquote_simple` changes the test function name but not the test logic. No test is deleted; the test is preserved with updated function name and updated calls to the renamed function.

### 14.5 Merge conflicts with concurrent work (LOW RISK)

PH-14 modifies only `src/parse.rs`. If other branches modify the same file, merge conflicts may arise. However, PH-14 is a standalone phase with no dependencies.

---

## 15. Deviations from Requirements

**No deviations found.** The current codebase matches the PRD's description exactly:

- `All` struct at line 282 with 14 occurrences (confirmed)
- `all2` function at line 301 with 9 occurrences (confirmed)
- `stdp` module at line 14 with 39 occurrences (confirmed)
- `do_unquote` function at line 93 with 3 occurrences (confirmed; PRD gap analysis says "5" but actual word-boundary count is 3)
- `do_unquote_non_escaped` function at line 115 with 5 occurrences (confirmed)
- No name collisions with any of the new names (`Tuple`, `tuple2`, `primitives`, `unquote_escaped`, `unquote_simple`)
- All 26 existing tests pass
- Only `src/parse.rs` requires modification
- Items explicitly out of scope (`A0`/`A1`/`A2` type params, `nz()` test helper, `AssetDsc.dsc`, arity suffixes on other combinators) are confirmed to not need changes

**Minor PRD count discrepancy (non-blocking):** The PRD's gap analysis section states "5 occurrences" for `do_unquote`, but the actual count of `do_unquote` occurrences (distinct from `do_unquote_non_escaped`, using word-boundary matching) is 3: the function definition (line 93), the intra-doc link (line 114), and the call site (line 129). This does not affect the implementation plan.

---

## 16. Commit Strategy

Per project conventions ("one issue category = one commit"), this entire phase is a single naming-improvement issue category and should be a single commit. All five renames plus doc comment updates go into one commit.
