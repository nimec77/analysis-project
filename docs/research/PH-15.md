# Research: PH-15 â€” Modularity (split `parse.rs`)

**Ticket:** PH-15
**Phase:** 15 of 22
**Status:** Research complete
**Dependencies:** Phase 14 complete (verified)

---

## 1. Current State

### 1.1 File Structure

```
src/
  lib.rs       (246 lines) - library crate, public API
  parse.rs     (1762 lines) - monolithic parser module
  main.rs      (71 lines) - CLI binary
```

No `src/parse/` directory exists yet.

### 1.2 `src/parse.rs` Section Boundaries (verified line numbers)

| Section | Lines | Span | Description |
|---|---|---|---|
| `Parser` trait | 1-6 | 6 lines | Core parser trait definition |
| `Parsable` trait | 7-12 | 6 lines | Self-constructing parser trait |
| `mod primitives` | 14-74 | 61 lines | Private sub-module: `U32`, `I32`, `Byte` |
| Helper functions | 77-122 | 46 lines | `quote`, `unquote_escaped`, `unquote_simple` |
| Combinator structs | 124-686 | 563 lines | `Unquote`, `Tag`, `QuotedTag`, `StripWhitespace`, `Delimited`, `Map`, `Preceded`, `Tuple`, `KeyValue`, `Permutation`, `List`, `Alt`, `Take` + all constructor functions + all `Parser` trait impls |
| **Combinator total** | **1-686** | **686 lines** | |
| `AUTHDATA_SIZE` constant | 688 | 1 line | `const AUTHDATA_SIZE: usize = 1024;` |
| Domain types | 690-877 | 188 lines | `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements`, `just_parse` |
| **Domain total** | **688-877** | **190 lines** | |
| Log hierarchy | 879-1345 | 467 lines | `LogKind`, `SystemLogKind`, `SystemLogTraceKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogTraceKind`, `AppLogJournalKind`, `LogLine` (definitions + all `Parsable` impls) |
| **Log total** | **879-1345** | **467 lines** | |
| Tests | 1347-1762 | 416 lines | Single `#[cfg(test)] mod test { ... }` block |
| **Grand total** | **1-1762** | **1762 lines** | |

### 1.3 Existing Warnings

Two existing warnings (not introduced by this phase):
1. `fn quote` is never used (line 77) -- only used inside `#[cfg(test)]`
2. `struct I32` is never constructed (line 44) -- only used inside `#[cfg(test)]`

These warnings exist pre-phase and must not increase.

### 1.4 Test Inventory (26 total tests)

All 26 tests pass. Distribution:

**Tests in `parse::test` (23 tests):**

*Combinator/primitives tests (11):*
- `test_u32` -- uses `primitives::U32`
- `test_i32` -- uses `primitives::I32`
- `test_quote` -- uses `quote()`
- `test_unquote_simple` -- uses `unquote_simple()`
- `test_unquote` -- uses `Unquote`
- `test_tag` -- uses `tag()`
- `test_quoted_tag` -- uses `quoted_tag()`
- `test_strip_whitespace` -- uses `strip_whitespace()`, `tag()`, `primitives::U32`
- `test_delimited` -- uses `delimited()`, `tag()`, `primitives::U32`
- `test_key_value` -- uses `key_value()`, `primitives::U32`
- `test_list` -- uses `list()`, `primitives::U32`

*Domain tests (10):*
- `test_authdata` -- uses `AuthData::parser()`
- `test_asset_dsc` -- uses `AssetDsc::parser()`, `tuple2()`, `strip_whitespace()`, `tag()`
- `test_backet` -- uses `Backet::parser()`
- `test_just_parse_asset_dsc` -- uses `just_parse::<AssetDsc>()`
- `test_just_parse_backet` -- uses `just_parse::<Backet>()`
- `test_just_parse_user_cash` -- uses `just_parse::<UserCash>()`
- `test_just_parse_user_backet` -- uses `just_parse::<UserBacket>()`
- `test_just_parse_user_backets` -- uses `just_parse::<UserBackets>()`
- `test_just_parse_announcements` -- uses `just_parse::<Announcements>()`
- `test_just_parse_error_cases` -- uses `just_parse::<AssetDsc>()`, `just_parse::<Backet>()`, `just_parse::<Announcements>()`

*Log hierarchy tests (2):*
- `test_log_kind` -- uses `LogKind::parser()`, `preceded()`, `strip_whitespace()`, `tag()`, `unquote()`, `AuthData`, `nz()`
- `test_withdraw_cash` -- uses `LogKind::parser()`, `nz()`

**Tests in `lib::test` (3 tests):**
- `test_all` -- uses `read_log()`, `ReadMode::All`
- `test_errors_mode` -- uses `read_log()`, `ReadMode::Errors`, `LogKind`, `SystemLogKind`, `AppLogKind`
- `test_exchanges_mode` -- uses `read_log()`, `ReadMode::Exchanges`, `LogKind`, `AppLogKind`, `AppLogJournalKind`

---

## 2. Dependency Analysis

### 2.1 Cross-Module Dependency Graph

```
combinators.rs  <--  domain.rs  <--  log.rs
     |                   ^              |
     |                   +--------------+
     |
     +-- primitives (private sub-module, inline)
```

**`combinators.rs` depends on:** Nothing (standalone). Contains `Parser`, `Parsable`, `primitives`, all combinator structs and constructors.

**`domain.rs` depends on `combinators`:**
- Traits: `Parser`, `Parsable`
- Structs (for type annotations): `Map`, `Delimited`, `Tuple`, `StripWhitespace`, `Tag`, `Permutation`, `KeyValue`, `Unquote`, `List`, `Take`
- Primitives: `primitives::U32`, `primitives::Byte`
- Constructor functions: `map`, `delimited`, `tuple2`, `strip_whitespace`, `tag`, `permutation2`, `key_value`, `unquote`, `list`, `take`

**`log.rs` depends on `combinators`:**
- Traits: `Parser`, `Parsable`
- Structs (for type annotations): `Map`, `Preceded`, `StripWhitespace`, `Tag`, `Alt`, `Unquote`, `Delimited`, `Permutation`, `KeyValue`, `List`
- Primitives: `primitives::U32`
- Constructor functions: `map`, `preceded`, `strip_whitespace`, `tag`, `alt2`, `alt3`, `alt4`, `alt8`, `unquote`, `delimited`, `permutation2`, `permutation3`, `key_value`

**`log.rs` depends on `domain`:**
- Types: `AuthData`, `UserCash`, `UserBacket`, `Announcements`, `Backet`

### 2.2 Public API Consumed by `lib.rs`

Types referenced in `src/lib.rs` via `use parse::*;`:
- `LogLine` (struct)
- `Parsable` (trait -- used via `<LogLine as Parsable>::Parser`)
- `Parser` (trait -- used via `.parse()` call)
- `LogKind` (enum)
- `SystemLogKind` (enum)
- `AppLogKind` (enum)
- `AppLogErrorKind` (enum -- used only in test pattern matches)
- `AppLogJournalKind` (enum)

### 2.3 Public API Consumed by `main.rs`

Types referenced in `src/main.rs` via fully-qualified paths:
- `analysis::parse::just_parse` (function)
- `analysis::parse::Announcements` (struct)

### 2.4 Items Requiring `pub use` Re-exports in Module Root

All items that are currently `pub` in `parse.rs` must remain accessible via `use parse::*;`. The minimum required re-exports:

```rust
// From combinators
pub use combinators::{Parser, Parsable};

// From domain
pub use domain::{AuthData, AssetDsc, Backet, UserCash, UserBacket, UserBackets, Announcements, just_parse};

// From log
pub use log::{LogLine, LogKind, SystemLogKind, SystemLogTraceKind, SystemLogErrorKind,
              AppLogKind, AppLogErrorKind, AppLogTraceKind, AppLogJournalKind};
```

However, using `pub use combinators::*; pub use domain::*; pub use log::*;` is simpler and covers all public items, including combinator structs that appear in `Parsable::Parser` type annotations.

---

## 3. Visibility Changes Required

### 3.1 Constructor Functions (currently private `fn`, need `pub(crate)`)

After the split, domain.rs and log.rs call constructor functions defined in combinators.rs. These must become `pub(crate)`:

| Function | Line | Called from domain.rs | Called from log.rs |
|---|---|---|---|
| `tag` | 149 | Yes | Yes |
| `unquote` | 133 | Yes | Yes |
| `quoted_tag` | 166 | No (only used internally by `key_value`) | No |
| `strip_whitespace` | 183 | Yes | Yes |
| `delimited` | 215 | Yes | Yes |
| `map` | 247 | Yes | Yes |
| `preceded` | 269 | No | Yes |
| `tuple2` | 301 | Yes | No |
| `key_value` | 359 | Yes | Yes |
| `permutation2` | 403 | Yes | Yes |
| `permutation3` | 463 | No | Yes |
| `list` | 504 | Yes | No |
| `alt2` | 529 | No | Yes |
| `alt3` | 552 | No | Yes |
| `alt4` | 584 | No | Yes |
| `alt8` | 639 | No | Yes |
| `take` | 684 | Yes | No |

**Recommendation:** Make all constructor functions `pub(crate)` uniformly, even if only called from one sub-module. This is simpler and consistent.

### 3.2 Helper Functions

| Function | Line | Current visibility | Used outside combinators? |
|---|---|---|---|
| `quote` | 77 | private | No (only in tests) |
| `unquote_escaped` | 93 | private | No (called by `Unquote::parse`) |
| `unquote_simple` | 115 | private | No (called by `QuotedTag::parse`) |

These can remain private within `combinators.rs`. They are only called by combinator structs' `Parser` impl methods.

### 3.3 `primitives` Module

Currently: `mod primitives { ... }` (private, inline in `parse.rs`).

After move to `combinators.rs`: Must become `pub(crate) mod primitives { ... }` so that `domain.rs` and `log.rs` can reference `primitives::U32`, `primitives::Byte`.

Alternative: re-export `primitives` types at the `combinators` level: `pub(crate) use primitives::{U32, I32, Byte};`. Either approach works.

**Recommendation:** Use `pub(crate) mod primitives` since the domain and log modules reference `primitives::U32` (with the module path prefix) in their type annotations. Keeping the path `primitives::U32` unchanged minimizes code churn.

### 3.4 `QuotedTag` Struct

Currently: `struct QuotedTag(Tag);` (private). Only used internally within `combinators.rs` (by `key_value` constructor and `quoted_tag` function). No visibility change needed.

### 3.5 `AUTHDATA_SIZE` Constant

Currently: `const AUTHDATA_SIZE: usize = 1024;` (private, line 688). Used only by `AuthData` in domain. Moves to `domain.rs`, stays private.

---

## 4. Edition 2024 Module Path Mechanics

The project uses `edition = "2024"` (confirmed in `Cargo.toml`). Under this edition:

- `src/parse.rs` can serve as both the module root AND have a sibling `src/parse/` directory for sub-modules.
- Sub-modules are placed at `src/parse/combinators.rs`, `src/parse/domain.rs`, `src/parse/log.rs`.
- No `mod.rs` files are needed or wanted.
- The compiler resolves `mod combinators;` in `src/parse.rs` to `src/parse/combinators.rs` automatically.

Rust nightly 1.95.0 (installed) fully supports edition 2024.

---

## 5. Test Distribution Plan

### 5.1 Helper Function `nz()`

The helper function `fn nz(n: u32) -> NonZeroU32` is used across all three test categories. It must be duplicated in each sub-module's test block, or each test block can define its own. Since it is a trivial one-liner, duplication is acceptable and keeps tests self-contained.

### 5.2 Combinator Tests -> `combinators.rs`

Tests: `test_u32`, `test_i32`, `test_quote`, `test_unquote_simple`, `test_unquote`, `test_tag`, `test_quoted_tag`, `test_strip_whitespace`, `test_delimited`, `test_key_value`, `test_list`

These tests use: `primitives::U32`, `primitives::I32`, `quote`, `unquote_simple`, `Unquote`, `tag`, `quoted_tag`, `strip_whitespace`, `delimited`, `key_value`, `list`, `nz`. All items are defined in `combinators.rs`, so `use super::*;` gives full access.

**Note:** `test_quote` uses `quote()` which is currently only used in tests. After the move, `quote()` remains private in `combinators.rs` and the test accesses it via `use super::*;` within the same file. No visibility change needed.

### 5.3 Domain Tests -> `domain.rs`

Tests: `test_authdata`, `test_asset_dsc`, `test_backet`, `test_just_parse_asset_dsc`, `test_just_parse_backet`, `test_just_parse_user_cash`, `test_just_parse_user_backet`, `test_just_parse_user_backets`, `test_just_parse_announcements`, `test_just_parse_error_cases`

These tests use: `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements`, `just_parse`, `tuple2`, `strip_whitespace`, `tag`, `nz`, `Parser` trait (for `.parse()` calls), `Parsable` trait (for `::parser()` calls).

**Import requirements:** `use super::*;` gives access to domain types. Combinator constructors (`tuple2`, `strip_whitespace`, `tag`) and traits (`Parser`, `Parsable`) need to be accessible. Since `domain.rs` must `use super::combinators::*;` (or equivalent) at the module level for its `Parsable` impls, the tests will inherit this access via `use super::*;`.

### 5.4 Log Tests -> `log.rs`

Tests: `test_log_kind`, `test_withdraw_cash`

These tests use: `LogKind`, `SystemLogKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogJournalKind`, `AppLogTraceKind`, `AuthData`, `UserCash`, `preceded`, `strip_whitespace`, `tag`, `unquote`, `nz`, `Parser` trait, `Parsable` trait.

**Import requirements:** `use super::*;` gives access to log types. Combinator constructors and domain types must be accessible. Since `log.rs` imports from both `combinators` and `domain` at the module level, the tests inherit this via `use super::*;`.

---

## 6. Implementation Strategy

### 6.1 Recommended Order

1. **Create `src/parse/` directory.**
2. **Create `src/parse/combinators.rs`** -- move lines 1-686 (traits, primitives, helpers, combinator structs/impls/constructors). Change constructor visibility to `pub(crate)`. Change `mod primitives` to `pub(crate) mod primitives`. Extract combinator tests into `#[cfg(test)] mod tests { ... }` at the bottom.
3. **Create `src/parse/domain.rs`** -- move lines 688-877 (AUTHDATA_SIZE, domain types, just_parse). Add `use super::combinators::*;` and `use super::combinators::primitives;` at the top. Extract domain tests into `#[cfg(test)] mod tests { ... }`.
4. **Create `src/parse/log.rs`** -- move lines 879-1345 (log enums, LogLine, all Parsable impls). Add `use super::combinators::*;`, `use super::combinators::primitives;`, and `use super::domain::*;` at the top. Extract log tests into `#[cfg(test)] mod tests { ... }`.
5. **Rewrite `src/parse.rs`** as module root:
   ```rust
   mod combinators;
   mod domain;
   mod log;

   pub use combinators::*;
   pub use domain::*;
   pub use log::*;
   ```
6. **`cargo test`** -- verify all 26 tests pass.
7. **`cargo run -- example.log`** -- verify identical output.

### 6.2 Import Strategy for Sub-Modules

**`domain.rs` top:**
```rust
use super::combinators::*;
use super::combinators::primitives;
```

**`log.rs` top:**
```rust
use super::combinators::*;
use super::combinators::primitives;
use super::domain::*;
```

This approach works because `pub use combinators::*;` in the module root re-exports all public items from combinators. But within the parse module itself, sub-modules reference each other via `super::`. The `use super::combinators::*;` pattern imports all `pub` and `pub(crate)` items from combinators into the sub-module scope.

### 6.3 Warning about `use super::combinators::primitives`

Domain and log modules reference `primitives::U32` etc. with the `primitives::` path prefix in their `type Parser = ...` associated type annotations. To maintain this path, the `primitives` module itself must be imported: `use super::combinators::primitives;`. Simply re-exporting `U32`, `I32`, `Byte` would break these type paths.

---

## 7. Risks and Mitigations

### 7.1 `log` Name Collision

The sub-module name `log` may conflict with Rust's built-in `log` (from the standard prelude or common crates). Since the project has zero dependencies, there is no `log` crate. The module name `log` is safe in this context. However, if a future phase adds the `log` crate, the name would conflict. For now, this is acceptable and matches the PRD requirement.

### 7.2 Glob Re-export Conflicts

Using `pub use combinators::*; pub use domain::*; pub use log::*;` could cause conflicts if the same name is exported from multiple sub-modules. Inspection confirms no name collisions exist:
- `combinators` exports: trait names (`Parser`, `Parsable`), combinator struct names (`Tag`, `Map`, `Alt`, etc.)
- `domain` exports: domain type names (`AuthData`, `AssetDsc`, `Backet`, etc.) and `just_parse`
- `log` exports: log enum/struct names (`LogLine`, `LogKind`, `SystemLogKind`, etc.)

No overlapping names.

### 7.3 Test Access to Private Items

Some tests use private functions (`quote`, `unquote_simple`, `tag`, `quoted_tag`). After the split:
- Combinator tests in `combinators.rs` access private items via `use super::*;` -- works (same file).
- Domain tests that use `tuple2`, `strip_whitespace`, `tag` -- these become `pub(crate)` constructors, accessible via `use super::*;`.
- Log tests that use `preceded`, `strip_whitespace`, `tag`, `unquote` -- same as above, `pub(crate)`.

### 7.4 `test_asset_dsc` Uses Combinator Constructors Directly

The test `test_asset_dsc` constructs a parser inline: `tuple2(strip_whitespace(tag("AssetDsc")), strip_whitespace(tag("{")))`. After the split, these constructors live in `combinators.rs` with `pub(crate)` visibility. The test in `domain.rs` accesses them via `use super::*;` which inherits the `use super::combinators::*;` import. This should work since `pub(crate)` items from a sibling module are accessible when imported.

### 7.5 Existing Warnings Must Not Increase

The two existing warnings (`quote` unused, `I32` unconstructed) are about items used only in `#[cfg(test)]`. After the split, these items and their tests stay in `combinators.rs`. The warnings will persist (they are pre-existing) but no new warnings should appear.

---

## 8. Deviations from Requirements

**None identified.** The current codebase state aligns with all PRD requirements. Phase 14 renames are verified complete (`Tuple`, `tuple2`, `primitives`, `unquote_escaped`, `unquote_simple` are all in place). The edition 2024 module path convention is supported. The dependency graph is strictly layered with no cycles.

---

## 9. Estimated Output File Sizes

| File | Content | Estimated Lines |
|---|---|---|
| `src/parse.rs` | Module root (mod + pub use) | ~8-10 lines |
| `src/parse/combinators.rs` | 686 lines code + 11 tests (~180 lines) + nz helper + imports | ~880 lines |
| `src/parse/domain.rs` | 190 lines code + 10 tests (~170 lines) + nz helper + imports | ~370 lines |
| `src/parse/log.rs` | 467 lines code + 2 tests (~80 lines) + nz helper + imports | ~560 lines |

---

## 10. Resolved Questions

The PRD had no open questions. The implementation path is mechanical:
1. Create directory.
2. Move code sections to new files.
3. Add imports.
4. Adjust visibility.
5. Write module root with re-exports.
6. Redistribute tests.
7. Verify with `cargo test && cargo run -- example.log`.

No new technical questions were discovered during research.
