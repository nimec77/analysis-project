# Tasklist: PH-10 -- Box the Large Enum Variant

**Status:** IMPLEMENT_STEP_OK
**Ticket:** PH-10
**PRD:** `docs/prd/PH-10.prd.md`
**Plan:** `docs/plan/PH-10.md`

---

## Context

Phase 10 reduces the stack size of the `LogKind` enum hierarchy by boxing the oversized `AuthData` payload in the `AppLogTraceKind::Connect` variant. The `AuthData` struct contains a `[u8; 1024]` array, which inflates every enum in the chain (`AppLogTraceKind` -> `AppLogKind` -> `LogKind` -> `LogLine`) to ~1040 bytes on the stack. After boxing, `Connect(Box<AuthData>)` stores an 8-byte pointer inline, reducing `LogLine` from ~1040 bytes to ~40 bytes. The parser closure and test assertion are updated accordingly, and both hint comments identifying this technical debt are removed.

No deviations identified in the plan -- the codebase matches the PRD's "before" state exactly.

---

## Tasks

- [x] **10.1 Remove hint comment above `AuthData` struct**

  In `src/parse.rs`, line 722, remove the line:
  ```
  // подсказка: довольно много места на стэке
  ```
  This comment identifies `AuthData` as oversized on the stack. The issue is resolved by boxing the variant that contains it.

  **Acceptance criteria:**
  1. Zero occurrences of `подсказка: довольно много места на стэке` in `src/parse.rs`.
  2. The `AuthData` struct definition (`pub struct AuthData([u8; AUTHDATA_SIZE])`) and its derives (`Debug, Clone, PartialEq`) are unchanged.

- [x] **10.2 Remove hint comment above `AppLogTraceKind` and change `Connect` variant to `Box<AuthData>`**

  In `src/parse.rs`, remove the hint comment at line 979:
  ```
  // подсказка: а поля не слишком много места на стэке занимают?
  ```
  And change the `Connect` variant at line 983 from `Connect(AuthData)` to `Connect(Box<AuthData>)`.

  **Acceptance criteria:**
  1. Zero occurrences of `подсказка: а поля не слишком много места на стэке занимают?` in `src/parse.rs`.
  2. The `AppLogTraceKind` enum contains `Connect(Box<AuthData>)` (not `Connect(AuthData)`).
  3. All other variants of `AppLogTraceKind` (`SendRequest`, `Check`, `GetResponse`) are unchanged.

- [x] **10.3 Update the parser closure to wrap `AuthData` in `Box::new()`**

  In `src/parse.rs`, line 1181, change the parser map closure from:
  ```rust
  |authdata| AppLogTraceKind::Connect(authdata),
  ```
  to:
  ```rust
  |authdata| AppLogTraceKind::Connect(Box::new(authdata)),
  ```
  The associated type `fn(AuthData) -> AppLogTraceKind` at line 1153 remains unchanged -- the non-capturing closure coerces to the function pointer type.

  **Acceptance criteria:**
  1. The parser closure for the `Connect` variant contains `Box::new(authdata)`.
  2. The associated `Parser` type in the `Parsable` impl for `AppLogTraceKind` still compiles (the `fn(AuthData) -> AppLogTraceKind` signature is compatible with the closure).

- [x] **10.4 Update `test_log_kind` expected value**

  In `src/parse.rs`, line 1652, change the expected value from:
  ```rust
  AppLogTraceKind::Connect(AuthData([0x30, 0xc3, ...]))
  ```
  to:
  ```rust
  AppLogTraceKind::Connect(Box::new(AuthData([0x30, 0xc3, ...])))
  ```
  The `test_authdata` test (line 1546) tests `AuthData::parser()` directly and does not reference the `Connect` variant -- it requires no changes.

  **Acceptance criteria:**
  1. The `test_log_kind` test expected value uses `Box::new(AuthData([...]))` inside the `Connect` variant.
  2. The `test_authdata` test is unchanged.

- [x] **10.5 Verify**

  Run acceptance checks to confirm the refactoring is complete and correct.

  **Acceptance criteria:**
  1. `cargo test` passes all tests. No test cases deleted or modified (only the expected value in `test_log_kind` is updated).
  2. `cargo run -- example.log` succeeds and output is identical to pre-refactoring (because `Box<T>` delegates `Debug` to `T::fmt()`).
  3. `Connect(Box<AuthData>)` is present in the enum definition.
  4. `Box::new(authdata)` is present in the parser closure.
  5. `Box::new(AuthData([...]))` is present in the `test_log_kind` test assertion.
  6. Zero occurrences of `подсказка: довольно много места на стэке` in `src/parse.rs`.
  7. Zero occurrences of `подсказка: а поля не слишком много места на стэке занимают?` in `src/parse.rs`.
  8. The `AuthData` struct definition is unchanged.
  9. The `test_authdata` test is unchanged.
  10. No changes in `src/lib.rs` or `src/main.rs`.
  11. Zero external dependencies added.
