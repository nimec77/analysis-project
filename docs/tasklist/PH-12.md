# Tasklist: PH-12 -- Remove `OnceLock` singleton

**Status:** IMPLEMENT_STEP_OK
**Ticket:** PH-12
**PRD:** `docs/prd/PH-12.prd.md`
**Plan:** `docs/plan/PH-12.md`

---

## Context

Phase 12 removes the `LOG_LINE_PARSER` `OnceLock` singleton from `src/parse.rs`. The `LogLineParser` struct wraps a `std::sync::OnceLock` around the `LogLine` parser, deferring construction until first use and caching the result. After Phase 1 (`String` -> `&str` migration), all parser combinators are lightweight stack-only structs with no heap allocations, making the `OnceLock` caching unnecessary. The parser is instead constructed once per `LogIterator` instance and stored as a field. The two hint comments identifying this technical debt are removed -- these are the last remaining `// подсказка:` hints in the codebase.

No deviations identified in the plan -- the codebase matches the PRD's "before" state exactly.

---

## Tasks

- [x] **12.1 Delete `LogLineParser` struct, impl, hint comments, and `LOG_LINE_PARSER` static from `parse.rs`**

  In `src/parse.rs`, delete the following 17 lines entirely (lines 1397-1413):
  1. Delete the `/// Парсер строки логов` doc comment and `pub struct LogLineParser` definition (lines 1397-1399).
  2. Delete the `impl LogLineParser` block with the `parse()` method (lines 1400-1406).
  3. Delete the two hint comments: `// подсказка: singleton, без которого можно обойтись` and `// парсеры не страшно вытащить в pub` (lines 1408-1409).
  4. Delete the `/// Единожды собранный парсер логов` doc comment (line 1410).
  5. Delete the `pub static LOG_LINE_PARSER: LogLineParser` declaration (lines 1411-1413).
  6. Preserve the blank line at line 1396 as a separator before `#[cfg(test)]`.

  **Acceptance criteria:**
  1. Zero occurrences of `LogLineParser` in `src/parse.rs`.
  2. Zero occurrences of `LOG_LINE_PARSER` in `src/parse.rs`.
  3. Zero occurrences of `std::sync::OnceLock` in `src/parse.rs`.
  4. Zero occurrences of `подсказка: singleton, без которого можно обойтись` in `src/parse.rs`.
  5. Zero occurrences of `парсеры не страшно вытащить в pub` in `src/parse.rs`.
  6. Zero occurrences of `Единожды собранный парсер логов` in `src/parse.rs`.

- [x] **12.2 Add `parser` field to `LogIterator<R>` struct in `lib.rs`**

  In `src/lib.rs`, add a new field to the `LogIterator<R>` struct (lines 18-24) after the existing `lines` field:
  ```rust
      parser: <LogLine as Parsable>::Parser,
  ```
  No new imports are needed. `LogLine`, `Parsable`, and `Parser` are already imported via `use parse::*;`.

  **Acceptance criteria:**
  1. `LogIterator<R>` has a field `parser: <LogLine as Parsable>::Parser`.
  2. No new imports added -- `LogLine` and `Parsable` are already available via the glob import.

- [x] **12.3 Initialize `parser` field in `LogIterator::new()`**

  In `src/lib.rs`, in the `LogIterator::new()` constructor (lines 25-39), add the parser initialization to the `Self { ... }` struct literal after the `lines` field:
  ```rust
              parser: LogLine::parser(),
  ```

  **Acceptance criteria:**
  1. `parser: LogLine::parser()` is present in the `Self { ... }` struct literal inside `LogIterator::new()`.
  2. The parser is constructed once per `LogIterator` instance (not per `next()` call).

- [x] **12.4 Replace `LOG_LINE_PARSER.parse(...)` with `self.parser.parse(...)` in `LogIterator::next()`**

  In `src/lib.rs`, in the `Iterator::next()` implementation for `LogIterator` (line 50), change:
  ```rust
              let Ok((remaining, result)) = LOG_LINE_PARSER.parse(line.trim()) else {
  ```
  to:
  ```rust
              let Ok((remaining, result)) = self.parser.parse(line.trim()) else {
  ```

  **Acceptance criteria:**
  1. Zero occurrences of `LOG_LINE_PARSER` in `src/lib.rs`.
  2. `self.parser.parse(line.trim())` is present in `LogIterator::next()`.

- [x] **12.5 Verify**

  Run acceptance checks to confirm the refactoring is complete and correct.

  **Acceptance criteria:**
  1. `cargo test` passes all tests. No test cases deleted.
  2. `cargo run -- example.log` succeeds and output is identical to pre-refactoring.
  3. `LogLineParser` struct is deleted from `src/parse.rs`.
  4. `pub static LOG_LINE_PARSER` is deleted from `src/parse.rs`.
  5. Zero occurrences of `std::sync::OnceLock` in `src/parse.rs`.
  6. Zero occurrences of `LOG_LINE_PARSER` in `src/lib.rs`.
  7. `parser: <LogLine as Parsable>::Parser` field is present in `LogIterator`.
  8. `parser: LogLine::parser()` is present in `LogIterator::new()`.
  9. `self.parser.parse(line.trim())` is present in `LogIterator::next()`.
  10. No changes in `src/main.rs`.
  11. No changes in test code.
  12. Zero external dependencies added.
  13. Number of tests is the same as before (none deleted).
  14. The hint comments `подсказка: singleton, без которого можно обойтись` and `парсеры не страшно вытащить в pub` are removed (the last remaining hints in the codebase).
