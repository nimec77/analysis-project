# Tasklist: PH-13 -- Bug fix + dead code cleanup

**Status:** REVIEW_OK
**Ticket:** PH-13
**PRD:** `docs/prd/PH-13.prd.md`
**Plan:** `docs/plan/PH-13.md`

---

## Context

Phase 13 addresses two issues in `src/parse.rs`: a copy-paste bug in the `WithdrawCash` parser arm and the removal of five unused code items. The `WithdrawCash` parser arm correctly parses the `"WithdrawCash"` tag and a `UserCash` payload, but the mapping closure produces `AppLogJournalKind::DepositCash(user_cash)` instead of `AppLogJournalKind::WithdrawCash(user_cash)` -- a copy-paste error from the `DepositCash` arm directly above. The dead code items (`AsIs`, `Either`, `Status`, `all3`, `all4`) are confirmed unused via project-wide search and compiler warnings. Only `src/parse.rs` is modified. Per project conventions, the bug fix and dead code cleanup are separate commits.

No deviations identified in the plan -- the codebase matches the PRD's description exactly.

---

## Tasks

- [x] **13.1 Fix `WithdrawCash` mapping bug in `AppLogJournalKind` parser**

  In `src/parse.rs`, in the `Parsable` impl for `AppLogJournalKind`, locate the `WithdrawCash` parser arm. Change the mapping closure from `AppLogJournalKind::DepositCash(user_cash)` to `AppLogJournalKind::WithdrawCash(user_cash)`.

  **Before:**
  ```rust
  map(
      preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
      |user_cash| AppLogJournalKind::DepositCash(user_cash),
  ),
  ```

  **After:**
  ```rust
  map(
      preceded(strip_whitespace(tag("WithdrawCash")), UserCash::parser()),
      |user_cash| AppLogJournalKind::WithdrawCash(user_cash),
  ),
  ```

  **Acceptance criteria:**
  1. The `WithdrawCash` parser arm maps to `AppLogJournalKind::WithdrawCash(user_cash)`, not `AppLogJournalKind::DepositCash(user_cash)`.
  2. `cargo build` compiles without errors. Existing tests pass.

- [x] **13.2 Add `test_withdraw_cash` regression test**

  In `src/parse.rs`, inside the `mod test` block, add a new test function `test_withdraw_cash` that parses a `WithdrawCash` log line and asserts the result is `AppLogJournalKind::WithdrawCash(...)`. The test uses `"count"` as the field name (per the actual `UserCash` parser) and the `nz()` helper consistent with other tests.

  ```rust
  #[test]
  fn test_withdraw_cash() {
      assert_eq!(
          LogKind::parser()
              .parse(r#"App::Journal WithdrawCash UserCash{"user_id":"Alice","count":500,}"#),
          Ok((
              "",
              LogKind::App(AppLogKind::Journal(AppLogJournalKind::WithdrawCash(
                  UserCash {
                      user_id: "Alice".into(),
                      count: nz(500)
                  }
              )))
          ))
      );
  }
  ```

  **Acceptance criteria:**
  1. `cargo test test_withdraw_cash` passes.
  2. The test asserts `AppLogJournalKind::WithdrawCash(...)` -- would fail if the bug from task 13.1 were still present.

- [x] **13.3 Remove unused `AsIs` struct and its `Parser` impl**

  In `src/parse.rs`, delete the `AsIs` struct definition, its `#[derive]` attribute, its doc comment, and the `impl Parser for AsIs` block (approximately 9 lines near line 136).

  **Acceptance criteria:**
  1. Zero occurrences of `AsIs` in `src/parse.rs`.
  2. `cargo build` compiles without errors.

- [x] **13.4 Remove unused `Either<Left, Right>` enum**

  In `src/parse.rs`, delete the `Either<Left, Right>` enum definition and its doc comment (approximately 5 lines near line 730).

  **Acceptance criteria:**
  1. Zero occurrences of `Either` in `src/parse.rs`.
  2. `cargo build` compiles without errors.

- [x] **13.5 Remove unused `Status` enum and its `Parsable` impl**

  In `src/parse.rs`, delete the `Status` enum definition, its doc comment, and the entire `impl Parsable for Status` block (approximately 23 lines near line 736).

  **Acceptance criteria:**
  1. Zero occurrences of `enum Status` in `src/parse.rs`.
  2. Zero occurrences of `impl Parsable for Status` in `src/parse.rs`.
  3. `cargo build` compiles without errors.

- [x] **13.6 Remove unused `all3()` constructor function**

  In `src/parse.rs`, delete the `all3()` function definition and its doc comments (approximately 7 lines near line 329). The `impl Parser for All<(A0, A1, A2)>` block is retained -- only the convenience constructor is removed.

  **Acceptance criteria:**
  1. Zero occurrences of `fn all3` in `src/parse.rs`.
  2. The `impl Parser for All<(A0, A1, A2)>` block is still present.
  3. `cargo build` compiles without errors.

- [x] **13.7 Remove unused `all4()` constructor function**

  In `src/parse.rs`, delete the `all4()` function definition and its doc comments (approximately 12 lines near line 354). The `impl Parser for All<(A0, A1, A2, A3)>` block is retained -- only the convenience constructor is removed.

  **Acceptance criteria:**
  1. Zero occurrences of `fn all4` in `src/parse.rs`.
  2. The `impl Parser for All<(A0, A1, A2, A3)>` block is still present.
  3. `cargo build` compiles without errors.

- [x] **13.8 Final verification**

  Run full acceptance checks to confirm both the bug fix and dead code removal are complete and correct.

  **Acceptance criteria:**
  1. `cargo test` passes all tests. No test cases deleted.
  2. `cargo run -- example.log` succeeds and output is identical to pre-phase.
  3. `test_withdraw_cash` test is present and passing.
  4. The `WithdrawCash` parser arm maps to `AppLogJournalKind::WithdrawCash`, not `DepositCash`.
  5. Zero occurrences of `AsIs` in `src/parse.rs`.
  6. Zero occurrences of `Either` in `src/parse.rs`.
  7. Zero occurrences of `enum Status` in `src/parse.rs`.
  8. Zero occurrences of `fn all3` in `src/parse.rs`.
  9. Zero occurrences of `fn all4` in `src/parse.rs`.
  10. Only `src/parse.rs` is modified. No changes to `src/lib.rs` or `src/main.rs`.
  11. No external dependencies added.
  12. Two commits: one for bug fix + regression test (tasks 13.1, 13.2), one for dead code cleanup (tasks 13.3-13.7).

## Review Fixes

- [x] **RF1: Create two separate commits per the required commit strategy**
  - All PH-13 changes to `src/parse.rs` are currently uncommitted in the working tree. The plan ("Commit Strategy" section), PRD (constraint #6), and tasklist (acceptance criteria 13.8 item 12) all require two separate commits.
  - **Commit 1 (bug fix):** Stage only the `WithdrawCash` bug fix (line 1262 change) and the `test_withdraw_cash` regression test (lines 1626-1641). Commit with a message indicating the bug fix (tasks 13.1, 13.2).
  - **Commit 2 (dead code cleanup):** Stage the remaining deletions (`AsIs`, `all3`, `all4`, `Either`, `Status`). Commit with a message indicating dead code removal (tasks 13.3-13.7).
  - **Acceptance:** `git log --oneline` shows two new commits for PH-13. The first commit contains only the bug fix and test. The second commit contains only the dead code removals. `cargo test` passes after each commit.
