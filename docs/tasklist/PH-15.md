# Tasklist: PH-15 â€” Modularity (split `parse.rs`)

**Status:** IMPLEMENT_STEP_OK
**Ticket:** PH-15
**PRD:** `docs/prd/PH-15.prd.md`
**Plan:** `docs/plan/PH-15.md`

---

## Context

Phase 15 splits the monolithic `src/parse.rs` (1762 lines) into a module directory with three sub-module files (`combinators.rs`, `domain.rs`, `log.rs`) and a thin module root. Constructor functions become `pub(crate)`, the `primitives` module becomes `pub(crate)`, and tests are redistributed into per-sub-module `#[cfg(test)] mod tests` blocks. Uses edition 2024 module paths (no `mod.rs`). No behavior changes, no API changes, no test deletions.

---

## Tasks

- [x] **1. Create `src/parse/` directory and `src/parse/combinators.rs`**
  Create the `src/parse/` directory. Move lines 1-686 from `src/parse.rs` into `src/parse/combinators.rs`: the `Parser` trait, `Parsable` trait, `mod primitives` (with `U32`, `I32`, `Byte`), helper functions (`quote`, `unquote_escaped`, `unquote_simple`), and all 13 combinator structs (`Tag`, `Unquote`, `QuotedTag`, `StripWhitespace`, `Delimited`, `Map`, `Preceded`, `Tuple`, `KeyValue`, `Permutation`, `List`, `Alt`, `Take`) with their `Parser` impls and constructor functions.
  - **AC1:** `src/parse/combinators.rs` exists and contains `pub trait Parser`, `pub trait Parsable`, the `primitives` sub-module, all 13 combinator structs, their `Parser` impls, all constructor functions, and the three helper functions.
  - **AC2:** No `mod.rs` files exist anywhere under `src/parse/`.

- [x] **2. Adjust visibility in `combinators.rs`: constructors to `pub(crate)`, primitives to `pub(crate) mod`**
  Change `mod primitives` to `pub(crate) mod primitives` so that `domain.rs` and `log.rs` can access `primitives::U32`, `primitives::Byte`. Change all 17 constructor functions from `fn` to `pub(crate) fn`: `unquote`, `tag`, `quoted_tag`, `strip_whitespace`, `delimited`, `map`, `preceded`, `tuple2`, `key_value`, `permutation2`, `permutation3`, `list`, `alt2`, `alt3`, `alt4`, `alt8`, `take`.
  - **AC1:** `primitives` module is declared as `pub(crate) mod primitives`.
  - **AC2:** All 17 constructor functions have `pub(crate)` visibility.

- [x] **3. Create `src/parse/domain.rs`**
  Move lines 688-877 from `src/parse.rs` into `src/parse/domain.rs`: `AUTHDATA_SIZE` constant, `AuthData`, `AssetDsc`, `Backet`, `UserCash`, `UserBacket`, `UserBackets`, `Announcements` (struct definitions + `Parsable` impls), and the `just_parse` function. Add `use super::combinators::*;` and `use super::combinators::primitives;` at the top for access to combinator types and primitives.
  - **AC1:** `src/parse/domain.rs` exists and contains all 7 domain struct definitions, their `Parsable` impls, the `AUTHDATA_SIZE` constant, and the `just_parse` function.
  - **AC2:** Domain types reference combinator types and primitives via `use super::combinators::*;` and `use super::combinators::primitives;`.

- [x] **4. Create `src/parse/log.rs`**
  Move lines 879-1345 from `src/parse.rs` into `src/parse/log.rs`: `LogKind`, `SystemLogKind`, `SystemLogTraceKind`, `SystemLogErrorKind`, `AppLogKind`, `AppLogErrorKind`, `AppLogTraceKind`, `AppLogJournalKind`, `LogLine` (enum/struct definitions + `Parsable` impls). Add `use super::combinators::*;`, `use super::combinators::primitives;`, and `use super::domain::*;` at the top.
  - **AC1:** `src/parse/log.rs` exists and contains all 9 enum/struct definitions and their `Parsable` impls.
  - **AC2:** Log types reference combinator types via `use super::combinators::*;`, primitives via `use super::combinators::primitives;`, and domain types via `use super::domain::*;`.

- [x] **5. Rewrite `src/parse.rs` as module root**
  Replace the entire content of `src/parse.rs` with the module root: `mod combinators; mod domain; mod log;` plus `pub use combinators::*; pub use domain::*; pub use log::*;` re-exports. This ensures `use parse::*;` in `lib.rs` continues to resolve all public types.
  - **AC1:** `src/parse.rs` contains only module declarations and `pub use` re-exports (approximately 8-10 lines).
  - **AC2:** `src/lib.rs` is unchanged (`pub mod parse; use parse::*;` compiles without modification).
  - **AC3:** `src/main.rs` is unchanged (`analysis::parse::just_parse` and `analysis::parse::Announcements` resolve via re-exports).

- [x] **6. Redistribute tests into per-sub-module `#[cfg(test)] mod tests` blocks**
  Split the monolithic test block (lines 1347-1762) into three test modules. Move 11 combinator tests (`test_u32`, `test_i32`, `test_quote`, `test_unquote_simple`, `test_unquote`, `test_tag`, `test_quoted_tag`, `test_strip_whitespace`, `test_delimited`, `test_key_value`, `test_list`) into `combinators.rs`. Move 10 domain tests (`test_authdata`, `test_asset_dsc`, `test_backet`, `test_just_parse_asset_dsc`, `test_just_parse_backet`, `test_just_parse_user_cash`, `test_just_parse_user_backet`, `test_just_parse_user_backets`, `test_just_parse_announcements`, `test_just_parse_error_cases`) into `domain.rs`. Move 2 log tests (`test_log_kind`, `test_withdraw_cash`) into `log.rs`. Each test module uses `use super::*;` and duplicates the `fn nz(n: u32) -> NonZeroU32` helper.
  - **AC1:** `combinators.rs` contains a `#[cfg(test)] mod tests` block with exactly 11 test functions.
  - **AC2:** `domain.rs` contains a `#[cfg(test)] mod tests` block with exactly 10 test functions.
  - **AC3:** `log.rs` contains a `#[cfg(test)] mod tests` block with exactly 2 test functions.
  - **AC4:** No test functions are deleted. All 23 parse tests are preserved.

- [x] **7. Verify: build, tests, and CLI output**
  Run `cargo build` (zero errors), `cargo test` (all 26 tests pass: 23 parse + 3 lib), `cargo run -- example.log` (output identical to pre-phase). Verify zero new compiler warnings, zero `mod.rs` files, `src/lib.rs` unchanged, `src/main.rs` unchanged.
  - **AC1:** `cargo build` compiles with zero errors.
  - **AC2:** `cargo test` passes all 26 tests (no test cases deleted).
  - **AC3:** `cargo run -- example.log` produces identical output to pre-phase.
  - **AC4:** No new compiler warnings introduced.
  - **AC5:** No `src/parse/mod.rs` file exists.
  - **AC6:** `src/lib.rs` and `src/main.rs` have zero modifications.
